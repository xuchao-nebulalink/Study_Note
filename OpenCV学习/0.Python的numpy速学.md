# Python的NumPy速学

## 为什么要学NumPy？

- ==OpenCV的图像就是NumPy数组==
- NumPy提供了高效的数组操作
- 图像的裁剪、拼接、运算都要用NumPy

**这份笔记只讲跟图像处理相关的NumPy知识，够用就行！**

---

## 安装和导入

```bash
pip install numpy
```

```python
import numpy as np  # 习惯性简写成np
```

---

## 1. 创建数组

### 从列表创建

```python
import numpy as np

# 一维数组
arr1 = np.array([1, 2, 3, 4, 5])
print(arr1)

# 二维数组
arr2 = np.array([[1, 2, 3],
                 [4, 5, 6]])
print(arr2)
```

**输出：**
```
[1 2 3 4 5]

[[1 2 3]
 [4 5 6]]
```

**对应到图像：**
- 灰度图 = 二维数组 `(高度, 宽度)`
- 彩色图 = 三维数组 `(高度, 宽度, 3通道)`

### 创建特殊数组

```python
import numpy as np

# 全零数组
zeros = np.zeros((3, 4))
print(zeros)

# 创建黑色图像（480高，640宽，3通道）
black_img = np.zeros((480, 640, 3), dtype=np.uint8)
print(f'黑色图像形状：{black_img.shape}')

# 创建白色图像
white_img = np.ones((480, 640, 3), dtype=np.uint8) * 255
print(f'白色图像最大值：{white_img.max()}')

# 随机整数数组（模拟图像）
rand_img = np.random.randint(0, 256, (100, 100, 3), dtype=np.uint8)
print(f'随机图像形状：{rand_img.shape}')

# 等差数列
arr = np.arange(0, 10, 2)
print(f'arange: {arr}')

# 等分数列
arr = np.linspace(0, 10, 5)
print(f'linspace: {arr}')
```

**输出：**
```
[[0. 0. 0. 0.]
 [0. 0. 0. 0.]
 [0. 0. 0. 0.]]
黑色图像形状：(480, 640, 3)
白色图像最大值：255
随机图像形状：(100, 100, 3)
arange: [0 2 4 6 8]
linspace: [ 0.   2.5  5.   7.5 10. ]
```

---

## 2. 数组的基本属性

```python
import numpy as np

arr = np.array([[1, 2, 3, 4],
                [5, 6, 7, 8],
                [9, 10, 11, 12]])

print(f'shape（形状）：{arr.shape}')
print(f'ndim（维度）：{arr.ndim}')
print(f'size（元素总数）：{arr.size}')
print(f'dtype（数据类型）：{arr.dtype}')

# 图像的例子
img = np.zeros((480, 640, 3), dtype=np.uint8)
print(f'\n图像形状：{img.shape}')
print(f'图像维度：{img.ndim}')
print(f'总像素数：{img.size}')
print(f'数据类型：{img.dtype}')
```

**输出：**
```
shape（形状）：(3, 4)
ndim（维度）：2
size（元素总数）：12
dtype（数据类型）：int32

图像形状：(480, 640, 3)
图像维度：3
总像素数：921600
数据类型：uint8
```

**重要的数据类型：**
- ==`uint8`==：0-255的整数（图像最常用）
- `int32`：整数
- `float64`：浮点数

---

## 3. 数组的索引和切片 ⭐⭐⭐

### 一维数组

```python
import numpy as np

arr = np.array([10, 20, 30, 40, 50])

print(f'第一个元素：{arr[0]}')
print(f'最后一个元素：{arr[-1]}')
print(f'切片[1:4]：{arr[1:4]}')
print(f'前3个：{arr[:3]}')
print(f'从索引2到结尾：{arr[2:]}')
print(f'步长为2：{arr[::2]}')
print(f'反转：{arr[::-1]}')
```

**输出：**
```
第一个元素：10
最后一个元素：50
切片[1:4]：[20 30 40]
前3个：[10 20 30]
从索引2到结尾：[30 40 50]
步长为2：[10 30 50]
反转：[50 40 30 20 10]
```

### 二维数组（重要！）

```python
import numpy as np

arr = np.array([[1,  2,  3,  4],
                [5,  6,  7,  8],
                [9, 10, 11, 12]])

# ==访问单个元素：arr[行, 列]==
print(f'arr[0, 0] = {arr[0, 0]}')
print(f'arr[1, 2] = {arr[1, 2]}')

# 访问一行
print(f'第一行：{arr[0]}')

# 访问一列
print(f'第一列：{arr[:, 0]}')

# 切片：提取子区域
sub = arr[0:2, 1:3]
print(f'子区域[0:2, 1:3]：\n{sub}')

# 提取多行多列
sub2 = arr[:2, :3]
print(f'前2行前3列：\n{sub2}')
```

**输出：**
```
arr[0, 0] = 1
arr[1, 2] = 7
第一行：[1 2 3 4]
第一列：[1 5 9]
子区域[0:2, 1:3]：
[[2 3]
 [6 7]]
前2行前3列：
[[1 2 3]
 [5 6 7]]
```

### 三维数组（彩色图像）

```python
import numpy as np

# 模拟2×3的彩色图像
img = np.array([[[100, 150, 200], [110, 160, 210], [120, 170, 220]],
                [[130, 180, 230], [140, 190, 240], [150, 200, 250]]])

print(f'图像形状：{img.shape}')

# 访问某个像素的BGR值
pixel = img[0, 0]
print(f'第一个像素（BGR）：{pixel}')

# 访问某个像素的某个通道
print(f'B通道：{img[0, 0, 0]}')
print(f'G通道：{img[0, 0, 1]}')
print(f'R通道：{img[0, 0, 2]}')

# 提取某个通道（整张图）
blue_channel = img[:, :, 0]
print(f'B通道（整图）：\n{blue_channel}')
```

**输出：**
```
图像形状：(2, 3, 3)
第一个像素（BGR）：[100 150 200]
B通道：100
G通道：150
R通道：200
B通道（整图）：
[[100 110 120]
 [130 140 150]]
```

---

## 4. 修改数组

```python
import numpy as np

arr = np.array([[1, 2, 3],
                [4, 5, 6],
                [7, 8, 9]])

# 修改单个元素
arr[0, 0] = 99
print(f'修改后：\n{arr}')

# 修改一行
arr[1, :] = [40, 50, 60]
print(f'修改第二行后：\n{arr}')

# 修改一块区域
arr[0:2, 0:2] = 0
print(f'修改区域后：\n{arr}')
```

**输出：**
```
修改后：
[[99  2  3]
 [ 4  5  6]
 [ 7  8  9]]
修改第二行后：
[[99  2  3]
 [40 50 60]
 [ 7  8  9]]
修改区域后：
[[ 0  0  3]
 [ 0  0 60]
 [ 7  8  9]]
```

---

## 5. 数组运算

```python
import numpy as np

arr = np.array([1, 2, 3, 4])

# 数组与标量运算
print(f'arr + 10 = {arr + 10}')
print(f'arr * 2 = {arr * 2}')
print(f'arr ** 2 = {arr ** 2}')

# 数组与数组运算
arr1 = np.array([1, 2, 3])
arr2 = np.array([4, 5, 6])
print(f'arr1 + arr2 = {arr1 + arr2}')
print(f'arr1 * arr2 = {arr1 * arr2}')

# 常用数学函数
arr = np.array([1, 2, 3, 4, 5])
print(f'\nsum（求和）：{np.sum(arr)}')
print(f'mean（平均）：{np.mean(arr)}')
print(f'max（最大）：{np.max(arr)}')
print(f'min（最小）：{np.min(arr)}')

# 指定轴的运算
arr = np.array([[1, 2, 3],
                [4, 5, 6]])
print(f'\n原数组：\n{arr}')
print(f'所有元素求和：{np.sum(arr)}')
print(f'按列求和（axis=0）：{np.sum(arr, axis=0)}')
print(f'按行求和（axis=1）：{np.sum(arr, axis=1)}')
```

**输出：**
```
arr + 10 = [11 12 13 14]
arr * 2 = [2 4 6 8]
arr ** 2 = [ 1  4  9 16]
arr1 + arr2 = [5 7 9]
arr1 * arr2 = [ 4 10 18]

sum（求和）：15
mean（平均）：3.0
max（最大）：5
min（最小）：1

原数组：
[[1 2 3]
 [4 5 6]]
所有元素求和：21
按列求和（axis=0）：[5 7 9]
按行求和（axis=1）：[ 6 15]
```

---

## 6. 数组形状操作

```python
import numpy as np

arr = np.array([[1, 2, 3, 4],
                [5, 6, 7, 8]])

print(f'原形状：{arr.shape}')
print(f'原数组：\n{arr}')

# reshape - 改变形状
reshaped = arr.reshape(4, 2)
print(f'\nreshape(4, 2)：\n{reshaped}')

# flatten - 展平成一维
flat = arr.flatten()
print(f'\nflatten：{flat}')

# 转置
transposed = arr.T
print(f'\n转置：\n{transposed}')
```

**输出：**
```
原形状：(2, 4)
原数组：
[[1 2 3 4]
 [5 6 7 8]]

reshape(4, 2)：
[[1 2]
 [3 4]
 [5 6]
 [7 8]]

flatten：[1 2 3 4 5 6 7 8]

转置：
[[1 5]
 [2 6]
 [3 7]
 [4 8]]
```

---

## 7. 数组拼接和分割

```python
import numpy as np

arr1 = np.array([[1, 2],
                 [3, 4]])
arr2 = np.array([[5, 6],
                 [7, 8]])

print('arr1:')
print(arr1)
print('\narr2:')
print(arr2)

# 垂直拼接（竖着拼）
v_concat = np.vstack([arr1, arr2])
print(f'\nvstack（垂直拼接）：\n{v_concat}')

# 水平拼接（横着拼）
h_concat = np.hstack([arr1, arr2])
print(f'\nhstack（水平拼接）：\n{h_concat}')
```

**输出：**
```
arr1:
[[1 2]
 [3 4]]

arr2:
[[5 6]
 [7 8]]

vstack（垂直拼接）：
[[1 2]
 [3 4]
 [5 6]
 [7 8]]

hstack（水平拼接）：
[[1 2 5 6]
 [3 4 7 8]]
```

---

## 8. 常用技巧（图像处理专用）

### 布尔索引

```python
import numpy as np

arr = np.array([10, 25, 30, 45, 50])

# 条件判断生成布尔数组
mask = arr > 30
print(f'arr > 30 的mask：{mask}')

# 用布尔数组索引
result = arr[mask]
print(f'筛选结果：{result}')
```

**输出：**
```
arr > 30 的mask：[False False False  True  True]
筛选结果：[45 50]
```

### where函数

```python
import numpy as np

arr = np.array([10, 20, 30, 40, 50])

# np.where(条件, 满足时的值, 不满足时的值)
result = np.where(arr > 25, 1, 0)
print(f'原数组：{arr}')
print(f'arr > 25 ? 1 : 0 = {result}')
```

**输出：**
```
原数组：[10 20 30 40 50]
arr > 25 ? 1 : 0 = [0 0 1 1 1]
```

### clip函数（限制范围）

```python
import numpy as np

arr = np.array([-10, 0, 50, 150, 300])
print(f'原数组：{arr}')

# 限制在0-255之间
clipped = np.clip(arr, 0, 255)
print(f'clip(0, 255)：{clipped}')
```

**输出：**
```
原数组：[ -10    0   50  150  300]
clip(0, 255)：[  0   0  50 150 255]
```

### 数组复制

```python
import numpy as np

arr1 = np.array([1, 2, 3])

# 错误的复制（只是引用）
arr2 = arr1
arr2[0] = 99
print(f'错误复制后，arr1 = {arr1}')  # arr1也变了！

# 正确的复制
arr1 = np.array([1, 2, 3])  # 重新创建
arr3 = arr1.copy()
arr3[0] = 999
print(f'正确复制后，arr1 = {arr1}')  # arr1不变
print(f'正确复制后，arr3 = {arr3}')
```

**输出：**
```
错误复制后，arr1 = [99  2  3]
正确复制后，arr1 = [1 2 3]
正确复制后，arr3 = [999   2   3]
```

---

## 9. 综合实战例子

### 例1：创建渐变图像

```python
import numpy as np

# 水平渐变（从黑到白）
img = np.linspace(0, 255, 256, dtype=np.uint8)
img = np.tile(img, (256, 1))  # 重复256行
print(f'渐变图像形状：{img.shape}')
print(f'第一行前5个像素：{img[0, :5]}')
print(f'最后一行后5个像素：{img[-1, -5:]}')
```

**输出：**
```
渐变图像形状：(256, 256)
第一行前5个像素：[0 1 2 3 4]
最后一行后5个像素：[250 251 252 253 254]
```

### 例2：图像翻转

```python
import numpy as np

img = np.array([[1, 2, 3],
                [4, 5, 6],
                [7, 8, 9]])

print(f'原图像：\n{img}')

# 上下翻转
flipped_v = img[::-1, :]
print(f'\n上下翻转：\n{flipped_v}')

# 左右翻转
flipped_h = img[:, ::-1]
print(f'\n左右翻转：\n{flipped_h}')

# 旋转180度
flipped_both = img[::-1, ::-1]
print(f'\n旋转180度：\n{flipped_both}')
```

**输出：**
```
原图像：
[[1 2 3]
 [4 5 6]
 [7 8 9]]

上下翻转：
[[7 8 9]
 [4 5 6]
 [1 2 3]]

左右翻转：
[[3 2 1]
 [6 5 4]
 [9 8 7]]

旋转180度：
[[9 8 7]
 [6 5 4]
 [3 2 1]]
```

### 例3：二值化（阈值处理）

```python
import numpy as np

# 模拟灰度图
img = np.array([[50, 100, 150],
                [200, 80, 220],
                [30, 180, 90]])

print(f'原图像：\n{img}')

# 阈值127，大于的变255，小于等于的变0
binary = np.where(img > 127, 255, 0)
print(f'\n二值化后：\n{binary}')
```

**输出：**
```
原图像：
[[ 50 100 150]
 [200  80 220]
 [ 30 180  90]]

二值化后：
[[  0   0 255]
 [255   0 255]
 [  0 255   0]]
```

---

## 10. 快速参考表

| 操作 | 代码 | 示例 |
|------|------|------|
| 创建数组 | `np.array([1,2,3])` | 从列表创建 |
| 全零 | `np.zeros((3,4))` | 3行4列全0 |
| 全1 | `np.ones((3,4))` | 3行4列全1 |
| 随机 | `np.random.randint(0,256,(h,w,3))` | 随机图像 |
| 形状 | `arr.shape` | 获取形状 |
| 访问 | `arr[行, 列]` | 访问元素 |
| 切片 | `arr[y1:y2, x1:x2]` | 提取区域 |
| 通道 | `arr[:, :, 0]` | B通道 |
| 求和 | `np.sum(arr)` | 求和 |
| 平均 | `np.mean(arr)` | 平均值 |
| 最值 | `np.max(arr)`, `np.min(arr)` | 最大最小 |
| 改形 | `arr.reshape(2,3)` | 改变形状 |
| 展平 | `arr.flatten()` | 变一维 |
| 垂直拼 | `np.vstack([arr1,arr2])` | 竖着拼 |
| 水平拼 | `np.hstack([arr1,arr2])` | 横着拼 |
| 限制 | `np.clip(arr, 0, 255)` | 限制范围 |
| 条件 | `np.where(arr>127, 255, 0)` | 条件替换 |
| 复制 | `arr.copy()` | 深拷贝 |

---

## 小结

**必须记住的5个要点：**

1. ==图像 = NumPy数组==
   - 灰度图：`(高, 宽)`
   - 彩色图：`(高, 宽, 3)`

2. ==切片语法==
   - `img[y1:y2, x1:x2]` - 裁剪区域
   - `img[:, :, 0]` - 提取B通道

3. ==数据类型==
   - 图像用 `uint8` (0-255)
   - `dtype=np.uint8`

4. ==防止溢出==
   - `np.clip(arr, 0, 255)` - 限制范围
   - `arr.astype(np.uint8)` - 转换类型

5. ==数组复制==
   - `arr.copy()` - 深拷贝
   - 避免用 `arr2 = arr1`

**学到这里，NumPy基础就够用了！可以开始学OpenCV了！** 🎉
