# 单片机开发环境安装指南

> 本文档包含STM32CubeIDE和PlatformIO的完整安装教程
> 适合新手从零开始搭建开发环境

---

## 📋 目录

1. [STM32CubeIDE 安装](#stm32cubeide-安装)
   - [安装Java JDK（必须）](#10-安装前准备安装java-jdk必须)
   - [下载和安装步骤](#11-下载-stm32cubeide)
2. [PlatformIO 安装](#platformio-安装)
3. [驱动程序安装](#驱动程序安装)
4. [验证安装](#验证安装)
5. [常见问题](#常见问题)
6. [正确的安装顺序](#七正确的安装顺序)

---

## 一、STM32CubeIDE 安装

> ⚠️ **重要提示**：
> - STM32CubeIDE 基于 Eclipse，**必须先安装 Java（JDK）** 才能运行！
> - STM32CubeIDE **只能开发 STM32 系列芯片**，不支持ESP32、Arduino等其他平台
> - 如需开发多种平台，建议使用 **PlatformIO**（支持STM32、ESP32、Arduino、Pico等）

### 💡 适用范围

**STM32CubeIDE 适合：**
- ✅ 只玩STM32芯片的用户
- ✅ 需要STM32官方图形化配置工具（CubeMX）的用户
- ✅ 专注STM32深度开发的用户

**不适合：**
- ❌ 想同时玩ESP32、Arduino等多种板子的用户
- ❌ 想用一个IDE管理所有项目的用户

**如果你有多种板子，请看：[二、PlatformIO 安装](#二platformio-安装)**

### 1.0 安装前准备：安装Java JDK（必须！）

#### 为什么需要Java？
STM32CubeIDE 是基于 Eclipse 开发的，Eclipse 需要 Java 运行环境才能工作。

#### Java安装步骤

**方法一：Oracle JDK（官方推荐）**

1. **下载地址：** https://www.oracle.com/java/technologies/downloads/

2. **选择版本：**
   - 推荐：`Java 21`（LTS长期支持版本）✅
   - 也可以：`Java 17`（LTS）或 `Java 25`（最新版）
   - 选择 Windows 标签
   - 下载 `x64 Installer`（约150MB）

> 💡 **版本说明：**
> - **Java 17/21** - LTS（长期支持）版本，最稳定 ⭐推荐
> - **Java 25** - 最新版本，功能最新，但可能有兼容性问题
> - STM32CubeIDE 支持 Java 11 及以上所有版本

3. **安装步骤：**
   - 双击下载的 `.exe` 文件
   - 点击 `Next`
   - 安装路径保持默认：`C:\Program Files\Java\jdk-21`
   - 点击 `Next` → `Install`
   - 等待安装完成（约2-3分钟）

4. **配置环境变量（必须！）**

> ⚠️ **重要**：Oracle JDK 安装后不会自动配置环境变量，必须手动配置！

**方法一：手动配置（推荐，直观）**

① 右键 `此电脑` → `属性` → `高级系统设置`

② 点击 `环境变量`

③ 在"系统变量"中点击 `新建`：
   - 变量名：`JAVA_HOME`
   - 变量值：`C:\Program Files\Java\jdk-21`
   - （根据你安装的版本修改：jdk-21、jdk-17 或 jdk-25）

④ 找到"系统变量"中的 `Path`，双击编辑

⑤ 点击 `新建`，添加：`%JAVA_HOME%\bin`

⑥ 点击 `确定` 保存所有窗口

**方法二：命令行快速配置**

以**管理员身份**打开 PowerShell，运行：

```powershell
# 设置JAVA_HOME（根据你的版本修改21为17或25）
setx JAVA_HOME "C:\Program Files\Java\jdk-21" /M

# 添加到PATH
setx PATH "%PATH%;%JAVA_HOME%\bin" /M
```

> 💡 执行后**必须重新打开cmd**才能生效

5. **验证安装：**
   - **重新打开**一个新的 cmd 窗口（旧窗口不会生效）
   - 输入命令：
   ```bash
   java -version
   ```
   - 应该显示类似：
   ```
   java version "21.0.x" 或 "17.0.x" 或 "25.x.x"
   Java(TM) SE Runtime Environment
   ```
   
   ✅ 看到版本号就说明配置成功！

#### 常见问题

**Q: 验证时提示"不是内部或外部命令"？**

**原因：**
- 环境变量配置有误
- 没有重新打开cmd窗口
- JAVA_HOME路径填写错误

**解决方案：**
1. 检查 JAVA_HOME 是否配置正确（参考上面第4步）
2. **必须重新打开cmd**窗口（旧窗口不会生效）
3. 确认Path中是否有 `%JAVA_HOME%\bin`
4. 检查Java实际安装路径是否与JAVA_HOME一致

---

### 1.1 下载 STM32CubeIDE

**官方下载地址：**
https://www.st.com/zh/development-tools/stm32cubeide.html

**步骤：**
1. 打开ST官网
2. 点击"获取软件"（Get Software）
3. 需要注册ST账号（免费）
4. 选择对应系统版本：
   - Windows：`en.st-stm32cubeide_xxx_win_x86_64.exe`
   - 大小约：1.5GB

> 💡 **提示**：下载较慢可以使用迅雷等下载工具

### 1.2 安装步骤

#### Step 1：运行安装程序
- 双击下载的 `.exe` 文件
- 如果提示需要管理员权限，点击"是"

#### Step 2：接受协议
- 勾选 `I accept the agreement`
- 点击 `Next`

#### Step 3：选择安装路径
```
默认路径：C:\ST\STM32CubeIDE_xxx
建议：保持默认，或选择非中文路径
```
⚠️ **注意**：路径中不要有中文和空格！

#### Step 4：安装选项
- ✅ 勾选 `STM32CubeMX`（图形化配置工具）
- ✅ 勾选 `ST-LINK Driver`（驱动程序）
- 点击 `Next`

#### Step 5：等待安装
- 安装时间约 5-10 分钟
- 安装过程中会自动安装：
  - Eclipse IDE
  - GCC编译器
  - GDB调试器
  - STM32CubeMX

#### Step 6：完成安装
- 勾选 `Launch STM32CubeIDE`
- 点击 `Finish`

### 1.3 首次启动配置

#### 选择工作空间（Workspace）
```
建议路径：E:\STM32_Workspace
或：D:\Project\STM32_Projects
```
⚠️ **注意**：
- 路径不要有中文
- 勾选 `Use this as the default` 设为默认

### 1.4 验证安装

1. 打开 STM32CubeIDE
2. 菜单栏：`Help` → `About STM32CubeIDE`
3. 查看版本信息（如：Version 1.14.0）

### 1.5 安装中文语言包（可选）

#### 为什么要中文化？
- 降低学习门槛
- 菜单、提示信息更易懂
- 帮助文档部分内容有中文

#### 安装步骤

**第一步：打开插件管理**

菜单栏：`Help` → `Install New Software...`

**第二步：添加语言包源**

1. 点击 `Add...` 按钮
2. 填写信息：
   - Name: `Babel Language Pack`
   - Location: `https://download.eclipse.org/technology/babel/update-site/latest/`
3. 点击 `Add` 确认

**第三步：选择中文语言包**

1. 在下拉菜单选择 `Babel Language Pack`
2. 等待列表加载（约1-2分钟）
3. 展开 `Babel Language Packs in Chinese (Simplified)`
4. 勾选：✅ `Babel Language Pack for eclipse in Chinese (Simplified)`
5. 点击 `Next` → `Next`
6. 接受许可协议 → `Finish`
7. 等待下载安装（约5-10分钟）

**第四步：重启生效**

1. 安装完成后提示重启
2. 点击 `Restart Now`
3. 重启后界面变为中文

> 💡 **提示**：
> - 中文化不是100%完整，部分专业术语仍为英文
> - 如果想切换回英文：`窗口` → `首选项` → `常规` → `外观` → 取消中文语言包

### 1.6 安装固件包（Firmware Package）⚠️ 重要

#### 什么是固件包？

STM32固件包包含：
- HAL库（硬件抽象层）
- LL库（底层驱动）
- 示例代码
- CMSIS库

创建项目、生成代码都需要！

#### 安装步骤

**第一步：登录ST账号**

1. **注册ST账号**（如果没有）
   - 访问：https://www.st.com/
   - 点击 **Sign In** → **Create Account**
   - 填写邮箱、密码等信息
   - 验证邮箱完成注册

2. **在STM32CubeIDE中登录**
   - 菜单：`Help` → `STM32Cube updates` → `Connection to myST`
   - 输入邮箱和密码
   - 点击 **Login**

**第二步：下载安装固件包**

**方法1：自动安装（推荐，但网络要求高）**

1. 菜单：`Help` → `Manage Embedded Software Packages`

2. 选择需要的芯片系列：
   - STM32F1：对应 F103、F101 等
   - STM32F4：对应 F407、F429 等
   - STM32H7：对应 H7 系列
   
3. 勾选最新版本

4. 点击 **Install Now**

5. 等待下载（约500MB-1GB，需10-30分钟）

**方法2：手动离线安装（网络不好时推荐）**

1. **下载固件包：**
   - 访问：https://www.st.com/en/embedded-software/stm32cube-mcu-mpu-packages.html
   - 选择对应系列（如 STM32CubeF1）
   - 下载 `.zip` 文件

2. **解压到指定位置：**
   ```
   C:\Users\用户名\STM32Cube\Repository\
   ```

3. **在CubeIDE中导入：**
   - `Help` → `Manage Embedded Software Packages`
   - 点击 `From Local...`
   - 选择解压后的文件夹

#### 常见问题

**Q: 下载失败 "Error downloading files" 或 "Download failed"**

原因：
- ST服务器在国外，网络不稳定
- 文件大，容易中断

解决：
- ✅ 多试几次（有时会成功）
- ✅ 换个时间段（晚上或早上）
- ✅ 使用手机热点
- ✅ **推荐：使用离线安装（方法2）**

**Q: 提示 "Please login to download"**

解决：参考上面"第一步：登录ST账号"

**Q: 提示 "Code generation could not be done"**

原因：缺少对应芯片的固件包

解决：安装对应系列的固件包（如F103需要STM32F1包）

**Q: 需要安装所有固件包吗？**

不需要！只安装你要用的芯片系列：
- 学习F103 → 只装 STM32F1
- 学习F407 → 只装 STM32F4
- 可以随时添加其他系列

> 💡 **建议**：新手可以先跳过固件包安装，等真正创建项目时再装

### 1.7 安装其他常用插件（可选）

#### 深色主题

内置深色主题，无需额外安装：

1. 菜单：`Window` → `Preferences`
2. 展开：`General` → `Appearance`
3. `Theme` 下拉选择：`Dark`
4. 点击 `Apply and Close`

#### Git插件（已内置）

STM32CubeIDE 已集成 EGit，无需安装

使用方法：
- `File` → `Import` → `Git` → `Projects from Git`
- 或右键项目 → `Team` → Git相关操作

---

## 二、PlatformIO 安装

PlatformIO 是 VS Code 的插件，所以需要先安装 VS Code

### 2.1 安装 Visual Studio Code

#### 下载
**官网：** https://code.visualstudio.com/

**步骤：**
1. 点击 `Download for Windows`
2. 下载 `VSCodeUserSetup-x64-xxx.exe`（约 100MB）

#### 安装
1. 双击安装程序
2. **重要选项**（务必勾选）：
   - ✅ 添加到 PATH（重要！）
   - ✅ 创建桌面快捷方式
   - ✅ 通过 Code 打开（添加右键菜单）
   - ✅ 将 Code 注册为支持的文件类型的编辑器

3. 点击 `Install` 安装

### 2.2 安装 PlatformIO 插件

#### 方法一：在线安装（推荐）

1. **打开 VS Code**

2. **打开扩展商店**
   - 点击左侧边栏的扩展图标（方块图标）
   - 或按快捷键：`Ctrl + Shift + X`

3. **搜索并安装**
   - 在搜索框输入：`PlatformIO IDE`
   - 找到官方插件（作者：PlatformIO）
   - 点击 `Install` 安装

4. **等待安装**
   - 首次安装需要下载约 300MB 文件
   - 右下角会显示安装进度
   - 大约需要 5-15 分钟

5. **重启 VS Code**
   - 安装完成后重启 VS Code
   - 左侧会出现 PlatformIO 图标（外星人头像）

#### 方法二：离线安装（网络不好时）

1. 下载 VSIX 文件
   - 访问：https://marketplace.visualstudio.com/items?itemName=platformio.platformio-ide
   - 点击右侧 `Download Extension`

2. 手动安装
   - VS Code 中按 `Ctrl + Shift + P`
   - 输入：`Extensions: Install from VSIX`
   - 选择下载的 `.vsix` 文件

### 2.3 配置 PlatformIO

#### 首次启动
1. 点击左侧 PlatformIO 图标（外星人）
2. 点击 `PIO Home` → `Open`
3. 等待初始化完成

#### 配置中文界面（可选）
1. 按 `Ctrl + Shift + P`
2. 输入：`Configure Display Language`
3. 选择 `中文（简体）`
4. 重启 VS Code

### 2.4 安装 STM32 平台支持

1. 打开 PlatformIO Home
2. 点击 `Platforms` 标签
3. 搜索：`ST STM32`
4. 找到 `ST STM32` 平台
5. 点击 `Install` 安装

**其他常用平台：**
- `Espressif 32`（ESP32）
- `Atmel AVR`（Arduino）
- `Raspberry Pi Pico`

---

## 三、驱动程序安装

### 3.1 ST-Link 驱动

#### 自动安装（推荐）
STM32CubeIDE 安装时已自动安装

#### 手动安装
1. 下载地址：https://www.st.com/zh/development-tools/stsw-link009.html
2. 运行安装程序
3. 一路 `Next` 完成安装

#### 验证驱动
1. 连接 ST-Link 到电脑
2. 打开设备管理器（`Win + X` → 设备管理器）
3. 展开 `通用串行总线控制器`
4. 应该看到：`STMicroelectronics STLink dongle`

### 3.2 USB转串口驱动

常见芯片驱动：

#### CH340/CH341（最常见）
- 下载：http://www.wch.cn/downloads/CH341SER_EXE.html
- 安装后在设备管理器看到 `USB-SERIAL CH340`

#### CP2102
- 下载：https://www.silabs.com/developers/usb-to-uart-bridge-vcp-drivers
- 安装后看到 `Silicon Labs CP210x USB to UART Bridge`

#### PL2303
- 下载：http://www.prolific.com.tw/US/ShowProduct.aspx?p_id=225
- 注意版本兼容性

---

## 四、验证安装

### 4.1 验证 STM32CubeIDE

#### 创建测试项目
1. 打开 STM32CubeIDE
2. `File` → `New` → `STM32 Project`
3. 选择芯片：`STM32F103C8`（如果你有这块板）
4. 项目名称：`Test_Project`
5. 点击 `Finish`

#### 编译测试
1. 右键项目 → `Build Project`
2. 查看控制台，应显示：
```
Build Finished. 0 errors, 0 warnings.
```

### 4.2 验证 PlatformIO

#### 创建测试项目
1. 打开 VS Code
2. 点击 PlatformIO 图标
3. 点击 `New Project`
4. 填写信息：
   - Name: `blink_test`
   - Board: `STM32 Nucleo F103RB`（或你的板子）
   - Framework: `Arduino` 或 `STM32Cube`
5. 点击 `Finish`

#### 编译测试
1. 打开 `src/main.cpp`
2. 点击底部状态栏的 `✓`（Build）
3. 等待编译完成
4. 应该显示：`SUCCESS`

---

## 五、常见问题

### 5.1 STM32CubeIDE 问题

#### Q1：运行安装程序立即报错 "Can't initialize plug-ins directory"

**原因：Windows用户名是中文！**⚠️

这是**最常见的坑**！安装程序会解压临时文件到 `C:\Users\用户名\AppData\Local\Temp\`，如果用户名是中文（如"徐超"），路径就包含中文，导致安装失败！

**解决方案：修改临时目录环境变量**

**方法1：修改TEMP和TMP环境变量（推荐）**

1. **创建临时文件夹**（纯英文路径）：
   - 打开文件资源管理器
   - 在D盘根目录新建文件夹：`Temp`
   - 最终路径：`D:\Temp`
   
   或用命令创建：
   ```cmd
   mkdir D:\Temp
   ```

2. 右键 `此电脑` → `属性` → `高级系统设置` → `环境变量`

3. 在"用户变量"中找到 `TEMP` 和 `TMP`：
   - 双击 `TEMP`，修改为：`D:\Temp`
   - 双击 `TMP`，修改为：`D:\Temp`

4. 点击 `确定` 保存

5. **重启电脑**（必须！）

6. 重新以管理员身份运行安装程序

> ⚠️ **注意**：`D:\Temp` 文件夹必须实际存在，否则会导致安装或编译失败！

**方法2：使用压缩软件解压安装**

1. 用7-Zip打开安装包：
   - 右键安装包 → `7-Zip` → `打开压缩包`
   
2. 解压到纯英文路径：
   ```
   D:\STM32CubeIDE_Temp
   ```

3. 进入解压目录运行安装程序

---

#### Q2：安装失败，无法完成安装（其他原因）

**可能原因：**
- 缺少Java环境（STM32CubeIDE基于Eclipse，需要JDK）
- 磁盘空间不足（需要约3GB）
- 杀毒软件拦截
- 安装包损坏

**解决方案：**

**步骤1：检查Java环境**
```bash
# 打开cmd运行
java -version
```
- 如果提示"不是内部或外部命令"，需要先安装JDK 21
- 参考前面的Java安装步骤

**步骤2：检查磁盘空间**
- C盘至少需要 5GB 剩余空间
- 安装路径的磁盘也要有 3GB+ 空间

**步骤3：临时关闭杀毒软件**
- Windows安全中心 → 病毒和威胁防护 → 暂时关闭实时保护
- 以管理员身份重新运行安装程序

**步骤4：尝试替代方案**
- 如果反复失败，建议先用 **VS Code + PlatformIO**
- 安装更简单，成功率高，同样支持STM32开发

#### Q3：安装完成后启动报错 "Can't initialize plug-ins directory"
**原因：**
- 安装目标路径包含中文或特殊字符
- 工作空间路径有中文
- 安装不完整或被杀毒软件拦截

**解决方案（必须完全卸载重装）：**
1. **完全卸载：**
   - `Win + R` → `appwiz.cpl` → 卸载 STM32CubeIDE
   - 删除残留：`C:\ST\`、`C:\Users\用户名\.eclipse`、`C:\Users\用户名\.stm32cubemx`

2. **重新安装（关键步骤）：**
   - 确保TEMP环境变量指向纯英文路径（参考Q1）
   - 暂时关闭杀毒软件
   - **以管理员身份运行**安装程序
   - 安装到纯英文路径：`C:\ST\STM32CubeIDE`
   - ❌ 避免：`C:\Program Files`（有空格）、`E:\学习笔记\`（有中文）

3. **首次启动：**
   - 以管理员身份运行
   - 工作空间也用纯英文路径：`E:\STM32_Workspace`

#### Q4：启动时卡在 "Loading workbench"
**解决方案：**
- 删除工作空间的 `.metadata` 文件夹
- 重新启动 STM32CubeIDE

#### Q5：无法识别 ST-Link
**解决方案：**
1. 重新安装 ST-Link 驱动
2. 更换 USB 线缆
3. 更新 ST-Link 固件：
   - `Help` → `ST-LINK Upgrade`

#### Q6：编译错误 "Cannot create temporary file" 或 "No such file or directory"

**错误示例：**
```
Cannot create temporary file in C:\Users\徐超\AppData\Local\Temp\: No such file or directory
arm-none-eabi-gcc: internal compiler error
```

**原因：中文用户名导致临时目录路径有问题**

**解决方案：**

1. **检查D:\Temp文件夹是否存在**
   - 如果不存在，创建它：
   ```cmd
   mkdir D:\Temp
   ```

2. **确认环境变量设置正确**
   - 右键 `此电脑` → `属性` → `高级系统设置` → `环境变量`
   - 检查用户变量：
     - `TEMP` = `D:\Temp`
     - `TMP` = `D:\Temp`

3. **重启STM32CubeIDE**（重要！）
   - 完全关闭IDE
   - 重新启动
   - 打开项目
   - 右键项目 → `Clean Project`
   - 重新 `Build Project`

4. **如果还不行，重启电脑**
   - 让环境变量完全生效

#### Q7：编译错误 "arm-none-eabi-gcc not found"
**解决方案：**
- 检查安装路径是否有中文
- 重新安装 STM32CubeIDE
- 确保安装时选择了完整工具链

### 5.2 PlatformIO 问题

#### Q1：安装失败或卡住
**解决方案：**
```bash
# 方法1：删除缓存重装
# 删除文件夹：C:\Users\你的用户名\.platformio
# 重新安装插件

# 方法2：手动安装核心
pip install platformio
```

#### Q2：下载速度慢
**解决方案：**
- 配置国内镜像
- 创建文件：`C:\Users\你的用户名\.platformio\platformio.ini`
```ini
[platformio]
; 使用清华镜像
extra_configs = 
    https://pypi.tuna.tsinghua.edu.cn/simple
```

#### Q3：编译错误 "Platform 'xxx' is not installed"
**解决方案：**
1. 打开 PlatformIO Home
2. Platforms → 安装对应平台
3. 或在终端运行：
```bash
pio platform install ststm32
```

### 5.3 驱动问题

#### Q1：设备管理器显示黄色感叹号
**解决方案：**
1. 右键设备 → 更新驱动程序
2. 浏览计算机查找驱动
3. 手动选择驱动文件

#### Q2：串口无法打开（Access Denied）
**解决方案：**
- 关闭其他占用串口的程序（串口助手、Arduino IDE等）
- 重新插拔USB
- 重启电脑

---

## 六、推荐安装的其他工具

### 6.1 串口调试工具

**推荐：**
1. **SSCOM**（串口调试助手）- 免费，功能强大
2. **PuTTY** - 轻量级
3. **MobaXterm** - 集成多种功能

### 6.2 Git 版本控制

**下载：** https://git-scm.com/

用于代码版本管理，强烈推荐安装

### 6.3 芯片手册查看器

**推荐：**
- **SumatraPDF** - 轻量级PDF阅读器
- **Adobe Acrobat Reader** - 功能完整

---

## 七、正确的安装顺序

### ✅ 推荐安装流程

**如果选择 STM32CubeIDE：**
```
第1步：安装 Java JDK 21/17（必须！）
  ↓
第2步：验证Java安装（java -version）
  ↓
第3步：安装 STM32CubeIDE
  ↓
第4步：安装 ST-Link 驱动
  ↓
第5步：安装串口驱动（CH340等）
```

**如果选择 PlatformIO：**
```
第1步：安装 Visual Studio Code
  ↓
第2步：安装 PlatformIO 插件
  ↓
第3步：安装 ST STM32 平台
  ↓
第4步：安装串口驱动（CH340等）
```

### 📚 安装完成后的学习顺序

```
1. 熟悉开发环境界面
   ↓
2. 创建第一个项目
   ↓
3. 点亮第一个 LED（GPIO）
   ↓
4. 串口通信（USART）
   ↓
5. 定时器、中断等外设
```

---

## 📚 相关链接

- [STM32CubeIDE 用户手册](https://www.st.com/resource/en/user_manual/um2609-stm32cubeide-user-guide-stmicroelectronics.pdf)
- [PlatformIO 官方文档](https://docs.platformio.org/)
- [STM32中文社区](https://www.stmcu.org.cn/)

---

> 💡 **提示**：安装过程中遇到问题，可以：
> 1. 查看本文档的"常见问题"部分
> 2. 搜索相关错误信息
> 3. 访问官方论坛求助

---

**最后更新时间：** 2024-10-22

