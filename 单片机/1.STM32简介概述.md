# STM32 简介（面向有编程基础的工程师）

> **一句话**：STM32 是 ST 公司的 32 位 ARM Cortex-M 系列微控制器家族，主打「高性价比 + 外设丰富 + 低功耗 + 生态完整」。它既能做最简单的点灯，也能做工业控制、物联网和实时系统。

## 1. 为什么选 STM32？

- **生态成熟**：官方 CubeMX/CubeIDE、HAL/LL 库、FreeRTOS 适配、论坛与教程齐全。
- **系列齐全**：从极低成本（G0/F0）到高性能（H7/U5），覆盖低功耗、无线、图像/音频、以太网等多种场景。
- **学习曲线友好**：既可用 **HAL** 快速开发，也可用 **寄存器/LL** 精细控制性能与资源。

---

## 2. 家族与选型速览

常见系列（记住用途即可）：

- **入门/低成本**：`F0`、`G0`（日常控制、替代 8/16 位 MCU）
    
- **经典通用**：`F1`（如 F103），教程多、资料多
    
- **模拟/控制增强**：`F3`（高精度 ADC、运放、比较器丰富）
    
- **性能进阶**：`F4/F7`（浮点、DSP，加速图像/音频/控制）
    
- **超高性能**：`H7`（双核可选、缓存丰富、带外设更全）
    
- **低功耗**：`L0/L4/L5/U5`（电池供电、超低待机电流）
    
- **无线**：`WB`（BLE）、`WL`（Sub-GHz/LoRa）
    

> **入门推荐**：`Nucleo-F401RE`（通用、教程多）、`Nucleo-G0B1RE`（便宜好用）、`F411RE/F303RE` 也很常见。国产资料多的「正点原子/野火」任一 STM32 教学板都可。

---

## 3. 型号命名怎么读？

以 **STM32F103C8T6** 为例：

- `STM32`：家族前缀
- `F1`：系列（功能/年代大类）    
- `03`：子系列/特征分档
- `C`：封装/引脚等级（决定 IO 数量）
- `8`：闪存容量档位（如 64 KB；“CB”常见是 128 KB）
- `T6`：封装材质/温度等级等
![[Pasted image 20251011165811.png]]
> 实际容量和外设要**以 Datasheet/Reference Manual 为准**。

## 4. ARM 内核与架构速查（面向嵌入式/系统工程师）

> **先分清三个层次**
> 
> - **架构（Architecture/ISA）**：ARMv6/7/8/9… 定义指令集、特性（AArch32/AArch64、NEON、TrustZone…）。
>     
> - **内核（Core / Microarchitecture）**：如 Cortex-M4、A53、R52、X4 等，具体实现某个/某几个架构版本。
>     
> - **SoC/芯片**：厂商把内核 + 外设封装成产品（如 STM32、骁龙、Apple M 等）。

### 1）按应用场景划分的三大「Profile」

| Profile                       | 典型内核                                                | 对应架构                           | 位宽                  | 存储保护                | 典型系统                             | 主要场景                          |
| ----------------------------- | --------------------------------------------------- | ------------------------------ | ------------------- | ------------------- | -------------------------------- | ----------------------------- |
| **Cortex-M**（微控制器）            | M0/M0+/M3/M4/M7/M23/M33/M35P/M55/M85                | ARMv6-M / v7-M / v8-M / v8.1-M | 32 位（AArch32）       | **MPU**（无 MMU）      | 裸机/RTOS（FreeRTOS、Zephyr…）        | 低功耗控制、传感、马达、IoT、工业控制（如 STM32） |
| **Cortex-R**（实时/安全）           | R4/R5/R7/R52/R52+/R82                               | ARMv7-R / v8-R                 | 32/64 位（R82 为 64 位） | MPU（R82 可带 **MMU**） | RTOS/安全实时，有的可跑 Linux（R82）        | 汽车、存储控制器、硬实时、安全认证             |
| **Cortex-A / Cortex-X**（应用处理） | A5/A7/A9/A53/A55/A72/A76/A78/A710/A720…；X1/X2/X3/X4 | ARMv7-A / v8-A / v9-A          | 32/64 位（主流为 64 位）   | **MMU**             | Linux/Android/Windows、Hypervisor | 手机/平板/PC/服务器/边缘计算             |

> **小结**：
> 
> - 需**硬实时/确定性**→ **R**/高端 **M**；
> - 需**低功耗+外设控制**→ **M**；
> - 需**复杂 OS/用户态应用**→ **A/X**（MMU 是关键分水岭）。

**STM32 常见内核**：
- **F0/G0** → **Cortex-M0/M0+**
- **F1** → **Cortex-M3**
- **F3/F4/G4** → **Cortex-M4**（DSP/FPU）
- **F7/H7** → **Cortex-M7**（高性能）
- **L5/U5/H5** → **Cortex-M33**（TrustZone-M，低功耗/安全）
![[Pasted image 20251011164320.png]]

# STM32 片上资源与外设总览

> 提醒：STM32 家族很大，并非每颗芯片都拥有下面所有模块；以 **Datasheet / Reference Manual / Errata** 为准。
![[Pasted image 20251011165514.png]]

## 1) 片上“基础资源”（Core & SoC 基础设施）

### 1.1 内核与调试

- **ARM Cortex-M**（M0/M0+/M3/M4/M7/M33/M55/M85 等），可选 **FPU/DSP**、Cache、TCM。
- **NVIC**：中断控制器（优先级/抢占）；**SysTick**：系统滴答定时器。
- **调试/追踪**：**SWD/JTAG**、**ITM/SWO**、DWT（周期计数/数据观察）、部分高端带 **ETM** 指令级追踪。
- **MPU**：内存保护单元（任务隔离、越界保护）。

### 1.2 存储与存储控制

- 片上 **Flash**（程序）与 **SRAM**（数据），部分带 **Backup SRAM**（掉电保持）。
    
- **Option Bytes**（读保、写保护、Boot 配置、BOR 等）。
    
- **外部存储接口**（视系列而定）：
    
    - **FMC/FSMC**：外接 **SRAM/SDRAM/NOR/NAND**；
        
    - **QUADSPI/OSPI**：外接 Quad/Octal SPI 闪存/PSRAM；
        
    - **SDIO/SDMMC**：SD 卡接口。
        

### 1.3 时钟与复位（RCC）

- 时钟源：**HSI/HSE**（高频内部/外部）、**LSI/LSE**（低速）、**PLL** 倍频。
    
- **时钟树**：总线分频（AHB/APB1/APB2/AXI 等），不同外设挂在不同域。
    
- 复位：**POR/PDR/BOR**，外部 **NRST**，软件复位；支持 **MCO** 输出时钟。
    

### 1.4 电源与低功耗

- 供电：**LDO/SMPS**（部分系列）、**VBAT** 备份域、**VREFBUF** 基准。
    
- 检测/保护：**PVD**（电压检测）、温度传感器。
    
- 低功耗模式：**Sleep / Stop / Standby / Shutdown**（越往后越省电，唤醒更慢）；多种 **唤醒源**（RTC、EXTI、外设）。
    

### 1.5 数据搬运与总线

- **DMA** 控制器：外设↔内存/内存↔内存无 CPU 参与；
    
- **DMAMUX**（部分系列）：灵活路由外设触发到 DMA 通道；
    
- 高端系列（如 H7）带 **AXI 总线矩阵 / I/D Cache / DTCM**，并有 **MDMA/BDMA** 等增强型 DMA。
    

### 1.6 安全与加速

- **TrustZone-M**（M33+）：安全/非安全世界隔离。
    
- **RDP/WRP/PCROP/OTP/HUK**：调试/读写/代码段保护、一次性密钥。
    
- **加密/杂项加速**：**AES、HASH（SHA）、PKA（公钥）、CRC**、**真随机 RNG**。
    
- 图形/多媒体（高端）：**DMA2D（Chrom-ART）**、**JPEG 编解码器**、**LTDC/MIPI-DSI** 显示控制等。
    

---

## 2) 外设族谱（Peripherals）

> 记忆法：**GPIO/EXTI → 定时器 → 通信 → 模拟 → 存储/图形/“其它”**。

### 2.1 GPIO / EXTI

- **GPIO**：输入/输出、上拉下拉、推挽/开漏、速度等级；**AF 复用** 把脚切到外设。
    
- **EXTI**：外部中断/事件控制，支持边沿/电平触发、唤醒。
    

### 2.2 定时器与看门狗

- **基本定时器**（TIM6/7）：仅计数/触发 DAC/中断。
    
- **通用定时器**（TIM2/3/4/5…）：**PWM、输入捕获、输出比较、编码器接口**。
    
- **高级定时器**（TIM1/TIM8…）：互补 PWM、死区、刹车（电机控制）。
    
- **HRTIM**（部分 G4/H7）：高分辨率电源/电机控制。
    
- **看门狗**：**IWDG**（独立，低速时钟）、**WWDG**（窗口）。
    
- **RTC**：日历、闹钟、时间戳、篡改检测、Backup 寄存器。
    

### 2.3 串行通信

- **USART/UART/LPUART**：全双工、自动波特率、LIN/IrDA/SmartCard（部分）。
    
- **SPI/I2S**：高速全双工；I2S 面向音频；**SAI/DFSDM/SPDIFRX**（高端音频）。
    
- **I2C**：标准/快速/快速+；多主从，需外部上拉。
    
- **I3C**（少数新系列）：兼容 I2C、带更高带宽/特性。
    
- **CAN/bxCAN/FDCAN**：工业/车载总线（CAN FD 带更高数据相位速率）。
    
- **USB**：**OTG FS/HS**（Device/Host/OTG，HS 需 PHY），常配 **MSC/CDC/HID** 类。
    
- **以太网 MAC**：RMII/MII/GMII/RGMII（需外置 PHY），可用 **LWIP**。
    
- **SDIO/SDMMC**：SD 卡读写；配 **FatFs** 文件系统。
    
- **QSPI/OSPI**：外接（Octal）SPI 闪存/PSRAM（XIP/数据盘）。
    
- **HDMI-CEC、IrDA、SMBUS、LIN** 等在部分系列可用。
    

### 2.4 模拟前端

- **ADC**：一般 ≥12-bit，多通道、扫描/触发、过采样、模拟看门狗，采样速率依系列而异。
    
- **DAC**：1~2 路，波形输出/音频/控制电压。
    
- **运放/比较器（OPAMP/COMP）**（如 F3/G4）：片上可编程放大/比较。
    
- **触摸感应（TSC）**：电容式触摸按键/滑条。
    
- **内部温度传感器、Vref、VBAT** 测量通道。
    

### 2.5 图像/显示与摄像（高端可选）

- **LTDC/MIPI-DSI**：TFT LCD 控制器；
    
- **DMA2D**：2D 图形加速（填充/混合/颜色空间转换）；
    
- **DCMI**：摄像头并口输入；**JPEG** 编解码。
    

---

## 3) 常见“使用清单”（Bring-up Checklist）

**开启一个外设（HAL/LL 通用思路）：**

1. **RCC 开时钟**：外设与其 GPIO 端口的时钟都要开。
    
2. **管脚复用**：配置 **GPIO 模式/上拉下拉/速度/AF**。
    
3. **复位外设**（可选）：确保寄存器处在干净状态。
    
4. **参数初始化**：波特率/极性/数据宽度/采样/触发源等。
    
5. **中断与优先级**：NVIC 里设置优先级并 **EnableIRQ**；ISR 里“快进快出”。
    
6. **DMA**（如需）：通道/数据宽度/环形/触发源；带 Cache 的系列注意 **Cache 一致性**。
    
7. **启动外设**：最后再 `Enable`，先验收信号（逻分/示波器/串口工具）。
    

**调时钟/精度相关：**

- USB/以太网/音频等对时钟敏感；优先用 **HSE 晶振 + PLL**，或校准 HSI；
    
- RTC 需 **LSE 32.768 kHz** 保证长期走时精度；
    
- 波特率不准：检查 **PLL/分频器** 与 **外设时钟域**。
    

**低功耗要点：**

- 仅开用到的时钟与 GPIO；
    
- 用 **DMA + 外设事件** 代替轮询；
    
- 选择恰当的 **Stop/Standby**，配好唤醒源（RTC/EXTI/通信接收）。
    

---

## 4) 典型需求 → 外设选型速查

|需求|外设/模块|备注|
|---|---|---|
|电机/舵机/灯光|高级/通用 **TIM**（PWM）+ **HRTIM**（高端）|互补 PWM、死区、刹车|
|传感器读取|**I2C/SPI** + **DMA** + **定时触发**|定时器触发 ADC/I2C 采样|
|数据记录到 SD 卡|**SDIO/SDMMC** + **FatFs**|带 DMA，注意文件系统缓存|
|上位机通讯/调试|**USART**（CDC-ACM 可选 USB）|`printf` 重定向或 ITM/SWO|
|以太网连接|**ETH MAC** + PHY + **LWIP**|RMII 常见；检查引脚复用|
|音频采集/播放|**I2S/SAI/DFSDM** + **DMA**|音频时钟树要精确|
|图形界面|**LTDC/MIPI-DSI + DMA2D**|外接 SDRAM 常见|
|安全/加密|**AES/HASH/PKA/RNG** + **TrustZone-M**|PCROP/RDP 配置保护代码|

---

## 5) 文档阅读顺序

1. **Datasheet**：引脚/封装、电气参数、外设清单、存储大小。
    
2. **Reference Manual**：寄存器与外设细节（最常翻）。
    
3. **Errata**：已知问题与规避方法（遇怪先看它）。
    
4. **应用笔记/示例工程**：Cube HAL/LL 自带示例与 AN 文档。
    

---

## 6) 小结

- “片上资源”= **内核/存储/时钟/电源/总线/DMA/安全/调试/低功耗**；
    
- “外设”= **GPIO/EXTI、定时器/RTC/看门狗、通信（UART/SPI/I2C/CAN/USB/ETH/SDMMC/QSPI…）、模拟（ADC/DAC/OPAMP/COMP/TSC）、图形多媒体**；
    
- 实操遵循 **RCC→GPIO AF→参数→NVIC/DMA→Enable** 的 Bring-up 流程。

# STM32 的系统结构
![[Pasted image 20251011171300.png]]
**一句话总览**：  
STM32 就是一颗「Cortex-M 内核」坐在中间，通过总线矩阵（AHB/APB/AXI）**把存储器（Flash/SRAM/外部存储）和一堆外设（GPIO、定时器、串口、SPI/I2C、ADC/DAC、USB/以太网…）连起来；旁边有时钟/复位（RCC）、电源/低功耗（PWR）、DMA负责搬运数据，还有调试/安全（SWD/TrustZone/加密/RNG）在保驾护航。

## 核心块怎么分？

1. **内核（Cortex-M + NVIC + SysTick + MPU/DWT）**
    - 跑你的代码；NVIC 统一处理中断；SysTick 给系统打“节拍”；MPU 做内存区域保护。
        
2. **存储系统**
    - 片上 **Flash** 放程序，**SRAM** 放数据；有的还带 **Backup SRAM**。
    - 需要更大容量时用 **外部存储接口**：FMC/FSMC（SRAM/SDRAM/NOR/NAND）、QSPI/OSPI（外置闪存/PSRAM）、SDMMC（SD 卡）。
        
3. **时钟与复位（RCC）**
    - 时钟源：HSI/HSE/PLL（高频）、LSI/LSE（低速/RTC）。
    - 负责整棵**时钟树**和各外设的“开关电源”（不给时钟外设就不转）；也管全芯片复位。
        
4. **总线矩阵 + DMA/DMAMUX**
    - **AHB/APB/AXI** 把内核、存储、外设分层连接；
    - **DMA** 让外设和内存直接搬数据，CPU 更省心更省电。
        
5. **外设群**
    - **GPIO/EXTI**（脚、复用、外部中断），**定时器/RTC/看门狗**，
    - **通信**：USART/UART、SPI/I2C/I3C、CAN/FDCAN、USB、以太网、SDMMC、QSPI/OSPI…
    - **模拟**：ADC/DAC/OPAMP/COMP；
    - **图形/摄像**（高端）：LTDC、DMA2D、DCMI、JPEG；
    - **安全/杂项**：AES/HASH/PKA、真随机 RNG、CRC、TrustZone-M。
        
6. **电源与低功耗（PWR/VBAT/PVD）**
    - 提供 LDO/（部分有）SMPS、备份域 VBAT；
    - 模式：Sleep / Stop / Standby（越省电唤醒越慢），RTC/EXTI 等作唤醒源。
        
7. **调试与追踪**
    - **SWD/JTAG**、**ITM/SWO**（高速日志）、DWT/ETM（高端有指令级追踪）。
        

## 实际“工作路径”（你写代码时的常用顺序）

1. 上电/复位 → 启动文件跳进 `SystemInit()` → `main()`
    
2. 配好 **RCC 时钟**（建议 CubeMX 生成）
    
3. **开外设与 GPIO 端口时钟**
    
4. 配 **GPIO 复用（AF）** 和外设参数（波特率/模式/触发）
    
5. 设 **NVIC** 优先级，必要时配 **DMA**
    
6. `Enable` 外设，开始跑主循环或 RTOS 任务

> 九成“外设不工作”的锅：**忘开时钟** / **GPIO 没切到 AF** / **时钟树配置错**。

# STM32 引脚怎么理解
![[Pasted image 20251011171632.png]]

## 1. 电源引脚：机器人的“口粮”

这是芯片工作的能量来源，是所有功能的基础。接错或漏接了芯片就无法工作。

- **VDD / VSS**: 这是最核心的数字电源。
    - VDD: 接电源**正极**，对于STM32通常是 **3.3V**。图上有 VDD_1, VDD_2 等，在使用时都需要连接。
    - VSS: 接电源**负极**，也就是 **地 (GND)**。图上的 VSS_1, VSS_2 等都需要接地。
        
- **VDDA / VSSA**: 这是模拟电路部分的专用电源。
    - VDDA: 模拟电源正极。主要为ADC、DAC等高精度模块供电。为了保证测量精度，这路电源要求更稳定、干扰更小。
    - VSSA: 模拟电源地。
        
- **VBAT** (引脚 1): 后备电池引脚。
    - 功能：为芯片内部的实时时钟（RTC）和一小块备份数据区供电。
    - 应用：外接一个纽扣电池（比如CR1220），即使主电源断开，芯片的时钟也能继续运行，保存的数据也不会丢失。
        

## 2. 时钟与复位引脚：机器人的“心跳”与“重启键”

- **PD0-OSC_IN / PD1-OSC_OUT** (引脚 5, 6): **高速外部时钟（HSE）**。
    - 功能：外接一个晶体振荡器（晶振），通常是 **8MHz**，为整个单片机提供主“心跳”（系统时钟）。芯片的所有运算和外设的运行速度都基于这个时钟。
        
- **PC14-OSC32_IN / PC15-OSC32_OUT** (引脚 3, 4): **低速外部时钟（LSE）**。
    - 功能：外接一个 **32.768KHz** 的晶振，专门给RTC（实时时钟）使用，保证时间的精确性。
        
- **NRST** (引脚 7): **复位引脚**。
    - 功能：此引脚被拉低时，单片机将立即复位（重启），程序从头开始执行。相当于电脑的Reset键。
        
- **BOOT0 / BOOT1** (引脚 44, 20): **启动模式选择引脚**。
    - 功能：通过设置这两个引脚的电平状态（高电平或低电平），来决定单片机上电后从哪里加载程序。
	**BOOT引脚如何设置**
	这两个引脚的电平组合决定了启动模式，具体对应关系如下表
## STM32的三种启动模式

STM32主要有三种启动模式，分别对应三种不同的存储区域：

1. **用户闪存 (Main Flash Memory)**: 这是最主要的存储空间，就是我们平时用JTAG/SWD下载器烧录 .hex 或 .bin 文件的地方。程序一旦烧进去，掉电也不会丢失。这是**正常工作**时使用的模式。
2. **系统存储器 (System Memory)**: 这块区域在芯片出厂时，ST官方已经固化了一段引导加载程序（Bootloader）这段程序主要用于**串口下载**（也叫ISP下载），即通过USART1接口将程序烧录到用户闪存中。这块区域是只读的（ROM），我们无法修改。
3. **内置SRAM**: 这是芯片内部的内存条（RAM），特点是读写速度飞快，但**掉电后数据会全部丢失**。这个模式主要用于**程序调试**，可以避免反复擦写Flash，提高调试效率。
![[Pasted image 20251011173607.png]]
![[Pasted image 20251011173713.png]]
## 3. 调试引脚：与机器人“沟通”的桥梁

这组引脚用于将我们写的程序下载到芯片中，并且可以在线调试（Debug），观察程序运行的每一步。

- **PA13 (JTMS/SWDIO)** (引脚 34)
- **PA14 (JTCK/SWCLK)** (引脚 37)
    
    - 功能：这两个引脚组成了 **SWD (Serial Wire Debug)** 调试接口。我们使用的ST-Link、J-Link等下载器就是通过它们与芯片进行通信的。
        
## 4. 通用输入/输出引脚 (GPIO)：机器人的“万能手脚”

这是数量最多，也是我们编程时打交道最多的引脚。它们的名字以 PAx, PBx, PCx 格式命名 (例如 PA0, PB12)。

每个GPIO口都非常灵活，可以被配置为多种工作模式：
- **输入模式**：读取外部信号的状态，例如检测按键是否被按下、读取传感器的高低电平信号。
- **输出模式**：对外输出高电平（3.3V）或低电平（0V），例如控制LED灯的亮灭、驱动电机、控制继电器。
    

### GPIO 的“多重身份” - 复用功能 (Alternate Function)

GPIO的强大之处在于，它们不仅仅是简单的I/O口，每个引脚大多还绑定了芯片内部其他外设的功能，这就是“复用”。

在编程时，我们可以将某个GPIO口从普通I/O模式切换到它的复用功能模式，让它“变身”为专用的通信接口或功能引脚。

**常见的复用功能：**

- **USARTx_TX / USARTx_RX**: **串口通信**。TX用于发送数据，RX用于接收数据。是实现单片机与电脑、GPS模块、蓝牙模块等进行文本数据交换的基础。
    
    - 例如：PA9 可以复用为 USART1_TX。
        
- **I2Cx_SCL / I2Cx_SDA**: **I2C通信**。SCL是时钟线，SDA是数据线。常用于连接各种传感器，如陀螺仪、温湿度传感器、OLED显示屏等。
    
- **SPIx_SCK / SPIx_MISO / SPIx_MOSI**: **SPI通信**。一种比I2C更快的主从式通信协议。常用于驱动TFT彩屏、读写SD卡、连接高速ADC等。
    
- **TIMx_CHx**: **定时器通道**。这是STM32的精髓之一。
    
    - **PWM输出**：可以输出脉宽调制波，用于控制LED的呼吸灯效果、伺服舵机的旋转角度、直流电机的转速等。
        
    - **输入捕获**：测量外部脉冲信号的频率和宽度。
        
    - 例如：PA8 可以复用为 TIM1_CH1。
        
- **ADCx_INx**: **模拟信号输入**。
    
    - 功能：将连续变化的电压信号（模拟信号）转换为单片机可以处理的数字值。
        
    - 应用：读取电位器（可调电阻）的旋钮位置、测量光敏电阻的亮度、读取各类模拟传感器的数值。
        
    - 例如：PA0 可以复用为 ADC12_IN0。
    -



# 学 STM32：软件安装与必做事项（简明版）

## 1）安装 Keil

- 安装 `MDK-ARM`，注册（可用免费 **MDK-Lite**，但**32KB 代码大小限制**）。
    
- 打开 **uVision**，别急着建工程，先装设备包。
    

## 2）在 Keil 里安装 **对应芯片的设备包（DFP）**

- 进 **Pack Installer**（菜单：`File → Pack Installer`）。
![[Pasted image 20251013001114.png]]
- 左侧选 `STMicroelectronics`，在中间列表找到你用的系列（如 **STM32F1 Series**）。
    
- 右侧 **Install**：
    
    - **CMSIS → CORE**（必装）
    - **Device → STM32F1xx_DFP**（或你的系列 DFP，**必装**）
    - 需要 HAL/LL 就装 **STM32Cube HAL/LL** 组件
- 安装后能看到一堆 **Examples**，后面建工程很方便。 

## 3）安装/验证 **ST-LINK 驱动**（很关键）
![[Pasted image 20251013001211.png]]
![[Pasted image 20251013001241.png]]


## 4）安装**串口驱动**（若用串口日志）
![[Pasted image 20251013001404.png]]
![[Pasted image 20251013001416.png]]