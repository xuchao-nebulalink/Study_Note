# 5镜控制器字符串通信协议

## 核心要点

**帧格式：** `$主命令,子命令[,设备号][,运动类型][,参数...]|;校验`

**必须字段：** 主命令、子命令
**可选字段：** 设备号、运动类型、参数（根据具体命令决定）

**批量控制：** 用`|`分隔多个完整命令，所有命令共用一个校验

**示例：**
```
单个命令：$3,3,1,3,100000;CRC
批量命令：$3,3,1,3,100000|3,3,2,4,200000|3,4,1,1,0;CRC
```

---

## 1. 设备清单

| 控制器         | 控制设备数 | 设备编号 |
| ----------- | ----- | ---- |
| 压电转盘控制器     | 1个转盘  | 1    |
| 压电螺钉控制器     | 3个螺钉  | 1-3  |
| 步进电机控制器1    | 3个电机  | 1-3  |
| 步进电机控制器2    | 3个电机  | 1-3  |
| 步进电机控制器3    | 3个电机  | 1-3  |
| 步进电机控制器4    | 1个电机  | 1    |
| 光栅尺（间接控制使用） | 6个    | 1-6  |

**说明：** 设备号0表示该控制器所有设备

---

## 2. 主命令定义

| 主命令  | 名称     | 说明             |
| ---- | ------ | -------------- |
| 0    | 系统查询   | 握手、查询系统状态等     |
| 1    | 系统参数设置 | 复位、设置系统参数等     |
| 2    | 传感器查询  | 查询各控制器状态       |
| 3    | 直接电机控制 | 直接控制电机、压电设备运动  |
| 4    | 间接控制电机 | 光栅尺闭环控制        |
| 5    | 找零命令   | 各控制器找零         |
| 6    | 急停命令   | 各控制器急停         |
| +128 | 应答     | 下位机应答（主命令+128） |
| 241  | 主动上报   | 运动完成、报警上报      |

**应答规则：** 应答主命令 = 发送主命令 + 128

---

## 3. 子命令定义（控制器）

| 子命令 | 控制器名称   | 控制设备   |
| --- | ------- | ------ |
| 0   | 所有控制器   | -      |
| 1   | 压电转盘控制器 | 1个转盘   |
| 2   | 压电螺钉控制器 | 3个螺钉   |
| 3   | 步进电机控制器1 | 3个步进电机 |
| 4   | 步进电机控制器2 | 3个步进电机 |
| 5   | 步进电机控制器3 | 3个步进电机 |
| 6   | 步进电机控制器4 | 1个步进电机 |

**说明：** 间接控制时还需要指定光栅尺编号

---

## 4. 设备号定义

| 设备号 | 含义   |
| --- | ---- |
| 0   | 所有设备 |
| 1   | 设备1  |
| 2   | 设备2  |
| 3   | 设备3  |
| ... | ...  |

---

## 5. 运动类型定义

| 数值  | 运动类型 | 适用设备          |
| --- | ---- | ------------- |
| 0   | 停止   | 所有            |
| 1   | 正转   | 螺钉，不支持负数      |
| 2   | 反转   | 螺钉，不支持负数      |
| 3   | 相对运动 | 步进电机、压电转盘、光栅尺 |
| 4   | 绝对运动 | 步进电机、压电转盘、光栅尺 |

---

## 6. 系统查询（主命令=0）

### 6.1 握手（子命令=0）

**上位机：**
```
$0,0,1;CRC

参数：主命令0(系统查询), 子命令0(握手), 协议版本1
```

**下位机：**
```
$128,0,0,1,12345678,5MirrorController,10,6,1.0.0.0;CRC

参数：
  主命令128(0+128), 子命令0, 状态0(成功), 版本1, 设备ID, 设备名, 
  电机总数10, 光栅尺6, 固件版本

状态：0成功 1失败 2版本不兼容
```

### 6.2 查询系统状态（子命令=1）

**上位机：**
```
$0,1;CRC

参数：主命令0, 子命令1
```

**下位机：**
```
$128,1,00,0000,10000,50,26;CRC

参数：主命令128, 子命令1, 系统状态00, 错误码0000, 运行时间(秒), CPU(%), 温度(℃)

系统状态：十六进制，bit0急停 bit1报警 bit2初始化完成
```

---

## 7. 系统参数设置（主命令=1）

### 7.1 复位（子命令=0）

**上位机：**
```
$1,0,0;CRC

参数：主命令1(系统参数设置), 子命令0(复位), 类型0(软复位)

类型：0软复位 1硬复位 2清错误
```

**下位机：**
```
$129,0,0;CRC

参数：主命令129(1+128), 子命令0, 状态0(成功)
```

### 7.2 心跳（子命令=1）

**上位机：**
```
$1,1,12345;CRC

参数：主命令1, 子命令1(心跳), 时间戳12345
```

**下位机：**
```
$129,1,0,12345,00;CRC

参数：主命令129, 子命令1, 状态0, 时间戳回显, 系统状态00
```

---

## 8. 传感器查询（主命令=2）

### 8.1 查询压电转盘（子命令=1）

**上位机：**
```
$2,1,1;CRC

参数：主命令2(传感器查询), 子命令1(压电转盘控制器), 设备号1
```

**下位机：**
```
$130,1,1,05,900000,1000,0000;CRC

参数：主命令130(2+128), 子命令1, 设备号1, 状态05, 角度(×10000), 转速, 错误码

状态bit：bit0运行中 bit1方向 bit2已找零 bit3报警
```

### 8.2 查询压电螺钉（子命令=2）

**上位机：**
```
$2,2,1;CRC

参数：主命令2, 子命令2(压电螺钉控制器), 设备号1
```

**下位机：**
```
$130,2,1,05,500,1000,0000;CRC

参数：主命令130, 子命令2, 设备号1, 状态05, 位置(μm), 速度, 错误码
```

### 8.3 查询步进电机控制器1-4（子命令=3/4/5/6）

**上位机：**
```
$2,3,1;CRC

参数：主命令2, 子命令3(步进电机控制器1), 设备号1
```

**下位机：**
```
$130,3,1,05,100000,10000,100000,0000;CRC

参数：主命令130, 子命令3, 设备号1, 状态05, 当前位置, 当前速度, 目标位置, 错误码

状态bit：bit0运行中 bit1方向 bit2已找零 bit3报警 bit4正限位 bit5负限位
```

### 8.4 查询光栅尺（子命令=7）

**上位机：**
```
$2,7,1;CRC

参数：主命令2, 子命令7(光栅尺), 设备号1
```

**下位机：**
```
$130,7,1,0F,25000,5000,0000;CRC

参数：主命令130, 子命令7, 设备号1, 状态0F, 位置(μm), 速度, 错误码

状态bit：bit0在线 bit1已找零 bit2数据有效 bit3报警
```

---

## 9. 直接电机控制（主命令=3）

### 9.1 压电转盘控制（子命令=1）

**上位机：**
```
$3,1,1,3,900000;CRC

参数：主命令3(直接控制), 子命令1(压电转盘), 设备号1, 运动类型3(角度定位), 角度900000(90度×10000)

运动类型：0停止 1正转 2反转 3角度定位
```

**下位机：**
```
$131,1,0,1;CRC

参数：主命令131(3+128), 子命令1, 状态0(成功), 设备号1

状态：0成功 1设备号无效 2设备忙 3参数错误 4未找零 5超限
```

### 9.2 压电螺钉控制（子命令=2）

**上位机：**
```
$3,2,1,3,500;CRC

参数：主命令3, 子命令2(压电螺钉), 设备号1, 运动类型3(相对), 位置500μm
```

**下位机：**
```
$131,2,0,1;CRC

参数：主命令131, 子命令2, 状态0, 设备号1
```

### 9.3 步进电机控制器1（子命令=3）

**上位机：**
```
$3,3,1,3,100000;CRC

参数：主命令3, 子命令3(步进电机控制器1), 设备号1, 运动类型3(相对), 位置100000

运动类型：0停止 1正转 2反转 3相对 4绝对
```

**下位机：**
```
$131,3,0,1;CRC

参数：主命令131, 子命令3, 状态0, 设备号1
```

### 9.4 步进电机控制器2/3/4（子命令=4/5/6）

格式同步进电机控制器1，子命令改为4/5/6

---

## 10. 间接控制电机（主命令=4）

### 10.1 光栅尺闭环控制（子命令=光栅尺号）

**上位机：**
```
$4,1,0,4,50000;CRC

参数：主命令4(间接控制), 子命令1(光栅尺1), 设备号0(此参数预留), 运动类型4(绝对), 目标位置50000μm

说明：电机控制器根据光栅尺1反馈闭环运动到目标位置
子命令：1-6对应光栅尺1-6
```

**下位机：**
```
$132,1,0,0;CRC

参数：主命令132(4+128), 子命令1(光栅尺1), 状态0(成功), 设备号0

状态：0成功 1光栅尺号无效 2参数错误 3光栅尺离线
```

---

## 11. 找零命令（主命令=5）

### 11.1 压电转盘找零（子命令=1）

**上位机：**
```
$5,1,1;CRC

参数：主命令5(找零), 子命令1(压电转盘), 设备号1
      设备号0表示所有设备
```

**下位机：**
```
$133,1,0,1,1,0;CRC

参数：主命令133(5+128), 子命令1, 状态0, 设备号1, 找零结果1(成功), 找零后位置0

状态：0成功 1设备号无效 2参数错误
找零结果：0找零中 1成功 2失败 3超时
```

### 11.2 压电螺钉找零（子命令=2）

**上位机：**
```
$5,2,1;CRC

参数：主命令5, 子命令2(压电螺钉), 设备号1
```

**下位机：**
```
$133,2,0,1,1,0;CRC

参数格式同上
```

### 11.3 步进电机找零（子命令=3/4/5/6）

**上位机：**
```
$5,3,1;CRC

参数：主命令5, 子命令3(步进电机控制器1), 设备号1
      设备号0表示该控制器所有电机
```

**下位机：**
```
$133,3,0,1,1,0;CRC

参数：主命令133, 子命令3, 状态0, 设备号1, 找零结果1, 位置0
```

### 11.4 光栅尺找零（子命令=7）

**上位机：**
```
$5,7,1;CRC

参数：主命令5, 子命令7(光栅尺), 设备号1
```

**下位机：**
```
$133,7,0,1,1,0;CRC

参数：主命令133, 子命令7, 状态0, 设备号1, 找零结果1, 位置0
```

---

## 12. 急停命令（主命令=6）

### 12.1 单个控制器急停

**上位机：**
```
$6,3,1,1;CRC

参数：主命令6(急停), 子命令3(步进电机控制器1), 设备号1, 模式1(立即停)
      设备号0表示该控制器所有设备

模式：0减速停 1立即停
```

**下位机：**
```
$134,3,0,1;CRC

参数：主命令134(6+128), 子命令3, 状态0, 设备号1

状态：0成功 1设备号无效
```

### 12.2 所有控制器急停

**上位机：**
```
$6,0,0,1;CRC

参数：主命令6, 子命令0(所有控制器), 设备号0, 模式1(立即停)
```

**下位机：**
```
$134,0,0,0;CRC

参数：主命令134, 子命令0, 状态0, 设备号0
```

---

## 13. 批量控制说明

用`|`分隔多个完整命令，所有命令共用一个校验。

**格式：** `$命令1|命令2|命令3;CRC`

**示例：批量控制3个不同电机**
```
$3,3,1,3,100000|3,4,2,4,200000|3,5,1,1,0;CRC

解析：
  命令1：步进电机控制器1-设备1-相对运动100000
  命令2：步进电机控制器2-设备2-绝对运动200000
  命令3：步进电机控制器3-设备1-正转位置0
```

**下位机应答（推荐分开）：**
```
$131,3,0,1;CRC
$131,4,0,2;CRC
$131,5,0,1;CRC
```

---

## 14. 主动上报（主命令=241）

### 14.1 运动完成上报（子命令=1）

**下位机：**
```
$241,1,3,1,0,100000,1000;CRC

参数：主命令241(上报), 子命令1(运动完成), 控制器3(步进电机控制器1), 
      设备号1, 完成状态0(正常), 最终位置100000, 运行时间1000ms

完成状态：0正常 1异常 2超时 3限位
```

### 14.2 报警上报（子命令=2）

**下位机：**
```
$241,2,2,3,1,0102,MotorOvercurrent;CRC

参数：主命令241, 子命令2(报警), 报警类型2(电机报警), 控制器3(步进电机控制器1), 
      设备号1, 错误码0102, 报警描述

报警类型：1急停 2电机报警 3传感器故障 4通信超时 5过温
```

---

## 15. 使用示例

### 示例1：握手

**上位机：**
```
$0,0,1;3A2F
```

**下位机：**
```
$128,0,0,1,12345678,5MirrorController,10,6,1.0.0.0;XXXX
```

### 示例2：控制步进电机控制器1的设备1相对运动

**上位机：**
```
$3,3,1,3,100000;XXXX
```

**下位机：**
```
$131,3,0,1;XXXX
```

**运动完成：**
```
$241,1,3,1,0,100000,1000;XXXX
```

### 示例3：查询步进电机控制器1的设备1状态

**上位机：**
```
$2,3,1;XXXX
```

**下位机：**
```
$130,3,1,05,100000,10000,100000,0000;XXXX
```

### 示例4：步进电机控制器1的设备1找零

**上位机：**
```
$5,3,1;XXXX
```

**下位机：**
```
$133,3,0,1,1,0;XXXX
```

### 示例5：急停步进电机控制器1的所有电机

**上位机：**
```
$6,3,0,1;XXXX

参数：急停, 步进电机控制器1, 所有设备(0), 立即停
```

**下位机：**
```
$134,3,0,0;XXXX
```

### 示例6：批量控制3个电机

**上位机：**
```
$3,3,1,3,100000|3,3,2,4,200000|3,4,1,1,0;XXXX

解析：
  命令1：步进电机控制器1, 设备1, 相对运动, 位置100000
  命令2：步进电机控制器1, 设备2, 绝对运动, 位置200000
  命令3：步进电机控制器2, 设备1, 正转, 位置0
```

**下位机：**
```
$131,3,0,1;XXXX
$131,3,0,2;XXXX
$131,4,0,1;XXXX
```

### 示例7：查询系统状态

**上位机：**
```
$0,1;XXXX
```

**下位机：**
```
$128,1,00,0000,10000,50,26;XXXX
```

### 示例8：光栅尺闭环控制

**上位机：**
```
$4,1,0,4,50000;XXXX

参数：间接控制, 光栅尺1, 设备号0(预留), 绝对运动, 目标位置50000μm
```

**下位机：**
```
$132,1,0,0;XXXX
```

### 示例9：急停所有控制器

**上位机：**
```
$6,0,0,1;XXXX

参数：急停, 所有控制器, 所有设备, 立即停
```

**下位机：**
```
$134,0,0,0;XXXX
```

---

## 16. CRC校验

**校验范围：** `$`到`;`之间的所有ASCII字符（不含`$`和`;`）

**Python代码：**
```python
def crc16_modbus(data: str) -> str:
    """计算字符串CRC16-MODBUS，返回4位十六进制"""
    crc = 0xFFFF
    for char in data:
        crc ^= ord(char)
        for _ in range(8):
            if crc & 0x0001:
                crc = (crc >> 1) ^ 0xA001
            else:
                crc >>= 1
    return f"{crc:04X}"

# 使用
cmd = "3,3,1,3,100000"
crc = crc16_modbus(cmd)
frame = f"${cmd};{crc}"
```

**C代码：**
```c
uint16_t crc16_modbus_str(const char* str) {
    uint16_t crc = 0xFFFF;
    while (*str) {
        crc ^= *str++;
        for (uint8_t i = 0; i < 8; i++) {
            if (crc & 0x0001) crc = (crc >> 1) ^ 0xA001;
            else crc >>= 1;
        }
    }
    return crc;
}

// 使用
char frame[256];
sprintf(frame, "$3,3,1,3,100000;%04X", crc16_modbus_str("3,3,1,3,100000"));
```

---

## 17. 命令速查表

| 功能            | 主命令 | 子命令 | 格式示例                  | 应答主命令 |
| ------------- | --- | --- | --------------------- | ----- |
| 握手            | 0   | 0   | `$0,0,1;CRC`          | 128   |
| 查询系统          | 0   | 1   | `$0,1;CRC`            | 128   |
| 复位            | 1   | 0   | `$1,0,类型;CRC`         | 129   |
| 心跳            | 1   | 1   | `$1,1,时间戳;CRC`        | 129   |
| 查询压电转盘        | 2   | 1   | `$2,1,设备;CRC`         | 130   |
| 查询压电螺钉        | 2   | 2   | `$2,2,设备;CRC`         | 130   |
| 查询步进电机控制器1    | 2   | 3   | `$2,3,设备;CRC`         | 130   |
| 查询步进电机控制器2    | 2   | 4   | `$2,4,设备;CRC`         | 130   |
| 查询步进电机控制器3    | 2   | 5   | `$2,5,设备;CRC`         | 130   |
| 查询步进电机控制器4    | 2   | 6   | `$2,6,设备;CRC`         | 130   |
| 查询光栅尺         | 2   | 7   | `$2,7,设备;CRC`         | 130   |
| 压电转盘控制        | 3   | 1   | `$3,1,设备,类型,角度;CRC`  | 131   |
| 压电螺钉控制        | 3   | 2   | `$3,2,设备,类型,位置;CRC`  | 131   |
| 步进电机控制器1控制    | 3   | 3   | `$3,3,设备,类型,位置;CRC`  | 131   |
| 步进电机控制器2控制    | 3   | 4   | `$3,4,设备,类型,位置;CRC`  | 131   |
| 步进电机控制器3控制    | 3   | 5   | `$3,5,设备,类型,位置;CRC`  | 131   |
| 步进电机控制器4控制    | 3   | 6   | `$3,6,设备,类型,位置;CRC`  | 131   |
| 光栅尺闭环控制（光栅尺1） | 4   | 1   | `$4,1,0,类型,位置;CRC`   | 132   |
| 光栅尺闭环控制（光栅尺2） | 4   | 2   | `$4,2,0,类型,位置;CRC`   | 132   |
| ...           | 4   | ... | ...                   | 132   |
| 光栅尺闭环控制（光栅尺6） | 4   | 6   | `$4,6,0,类型,位置;CRC`   | 132   |
| 压电转盘找零        | 5   | 1   | `$5,1,设备;CRC`         | 133   |
| 压电螺钉找零        | 5   | 2   | `$5,2,设备;CRC`         | 133   |
| 步进电机控制器1找零    | 5   | 3   | `$5,3,设备;CRC`         | 133   |
| 步进电机控制器2找零    | 5   | 4   | `$5,4,设备;CRC`         | 133   |
| 步进电机控制器3找零    | 5   | 5   | `$5,5,设备;CRC`         | 133   |
| 步进电机控制器4找零    | 5   | 6   | `$5,6,设备;CRC`         | 133   |
| 光栅尺找零         | 5   | 7   | `$5,7,设备;CRC`         | 133   |
| 压电转盘急停        | 6   | 1   | `$6,1,设备,模式;CRC`     | 134   |
| 压电螺钉急停        | 6   | 2   | `$6,2,设备,模式;CRC`     | 134   |
| 步进电机控制器1急停    | 6   | 3   | `$6,3,设备,模式;CRC`     | 134   |
| 步进电机控制器2急停    | 6   | 4   | `$6,4,设备,模式;CRC`     | 134   |
| 步进电机控制器3急停    | 6   | 5   | `$6,5,设备,模式;CRC`     | 134   |
| 步进电机控制器4急停    | 6   | 6   | `$6,6,设备,模式;CRC`     | 134   |
| 光栅尺急停         | 6   | 7   | `$6,7,设备,模式;CRC`     | 134   |
| 所有控制器急停       | 6   | 0   | `$6,0,0,模式;CRC`      | 134   |
| 运动完成上报        | 241 | 1   | `$241,1,控制器,设备,状态,...;CRC` | -     |
| 报警上报          | 241 | 2   | `$241,2,类型,控制器,设备,...;CRC` | -     |

---

## 18. 错误码

| 范围            | 类型          |
| ------------- | ----------- |
| 0000-00FF     | 通用错误        |
| 0100-01FF     | 电机错误        |
| 0200-02FF     | 光栅尺错误       |
| 0300-03FF     | 压电设备错误      |

**常用错误码：**
```
0000 无错误
0001 未知错误
0002 命令不支持
0003 参数错误
0004 设备忙
0009 未找零
000A 超出限位
0100 电机通用错误
0102 电机过流
0105 正限位触发
0106 负限位触发
```

---

## FAQ

**Q: 主命令和子命令的对应关系？**
A: 主命令是功能类别（查询、控制、找零等），子命令指定具体控制器（压电转盘=1，压电螺钉=2，步进电机=3/4/5/6，光栅尺=7）。

**Q: 设备号0是什么意思？**
A: 表示该控制器下的所有设备。比如`$6,3,0,1`表示急停步进电机控制器1的所有3个电机。

**Q: 批量命令如何发送？**
A: 用`|`分隔多个完整命令。例如：`$3,3,1,3,100|3,4,2,4,200;CRC` 同时控制2个电机。

**Q: 下位机如何应答批量命令？**
A: 推荐分开发送多个应答帧，简单清晰。也可以用`|`合并成一个应答帧。

**Q: 间接控制的子命令是什么？**
A: 子命令是光栅尺编号（1-6），例如`$4,1,0,4,50000`表示根据光栅尺1闭环控制到50000μm。

**Q: 找零命令为什么没有参数？**
A: 找零的方向、速度、模式等参数已经在下位机固化，找零时只需指定设备号。

**Q: CRC如何计算？**
A: 对`$`到`;`之间的字符串计算CRC16-MODBUS，结果转成4位十六进制大写字符串。

**Q: 应答主命令怎么算？**
A: 应答主命令 = 发送主命令 + 128。例如发送主命令3，应答就是131。

---

## 版本

| 版本  | 日期         | 改动                        |
| --- | ---------- | ------------------------- |
| v3.0 | 2025-10-27 | 根据实际代码枚举定义重新设计协议，匹配实际硬件配置 |

---

**重要说明：**

1. **帧格式：** `$主命令,子命令[,可选参数...];CRC`
2. **字段分隔：** 逗号`,`分隔所有字段
3. **批量控制：** 竖线`|`分隔多个完整命令，所有命令共用一个校验
4. **应答规则：** 应答主命令 = 发送主命令 + 128
5. **控制器分配：**
   - 0=所有控制器
   - 1=压电转盘（1个设备）
   - 2=压电螺钉（3个设备）
   - 3/4/5/6=步进电机控制器1/2/3/4
   - 7=光栅尺（6个，仅用于查询和间接控制）
6. **设备号：** 0=所有设备，1-N=具体设备
7. **数字格式：** 全部十进制，状态和错误码用十六进制
8. **CRC：** 4位十六进制大写字符串
9. **速度和加速度：** 预先配置好，运动命令中不指定
10. **光栅尺：** 只能通过间接控制（主命令4），不能直接控制
