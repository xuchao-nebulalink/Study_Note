# 5镜控制器通信协议

## 核心要点

**帧格式：** `$长度(2) + 命令(2) + 参数(N);CRC(2)`

**命令规则：**
- 上位机发送：0x01-0x06
- 下位机应答：发送命令+0x8000（0x81-0x86）
- 下位机上报：0xF1xx

---

## 1. 设备清单

| 设备     | 数量   | 编号        |
| ------ | ---- | --------- |
| 光栅尺    | 6    | 0x00-0x05 |
| 电机控制器1 | 6个电机 | 0x00-0x05 |
| 电机控制器2 | 5个电机 | 0x06-0x0A |
| 压电转盘   | 1    | 0x00      |
| 压电螺钉   | 3    | 0x00-0x02 |

---

## 2. 帧格式

```
$[数据部分];[校验]
```

**数据部分内容（二进制）：**
```
长度(2字节) + 命令(2字节) + 参数(N字节)
```

**字段说明：**
- `$` 帧头（固定）
- 长度：数据部分长度（`$`到`;`之间），小端序
- 命令：主命令+子命令（2字节）
- 参数：根据命令不同而变化，可以是0字节
- `;` 帧尾（固定）
- 校验：CRC16-MODBUS（2字节），校验`$`到`;`之间的所有数据

**长度计算公式：** 长度 = 2(长度字段) + 2(命令字段) + N(参数字节数)

---

## 3. 命令分类

| 命令码       | 功能              |
| --------- | --------------- |
| 0x01      | 系统（握手、复位、状态）    |
| 0x02      | 电机控制            |
| 0x03      | 光栅尺控制           |
| 0x04      | 压电转盘            |
| 0x05      | 压电螺钉            |
| 0x06      | 批量控制            |
| 0x07-0x7F | 预留（未来扩展）        |
| 0x81-0x86 | 应答（对应0x01-0x06） |
| 0xF1      | 主动上报            |

**说明：** 下位机应答命令 = 上位机发送命令 + 0x8000（例如：0x0100→0x8100）

---

## 4. 系统命令 (0x01)

### 握手 (0x0100)

**上位机发送：**
```
命令: 0x0100
参数: 协议版本(1字节)
```

**下位机返回：**
```
命令: 0x8100
参数:
  状态(1) + 版本(1) + 设备ID(4) + 设备名(32) + 
  电机数(1) + 光栅尺数(1) + 压电转盘数(1) + 压电螺钉数(1) + 固件版本(4)
  
  状态：0成功 1失败 2版本不兼容
```

### 心跳 (0x0101)

**上位机发送：**
```
命令: 0x0101
参数: 时间戳(4字节，毫秒)
```

**下位机返回：**
```
命令: 0x8101
参数: 状态(1) + 时间戳回显(4) + 系统状态(1)
      
      状态：0成功 1失败
      系统状态：bit0急停 bit1报警 bit2-7保留
```

### 复位 (0x0102)

**上位机发送：**
```
命令: 0x0102
参数: 复位类型(1字节)
      0:软复位 1:硬复位 2:清错误
```

**下位机返回：**
```
命令: 0x8102
参数: 状态(1字节)
      
      状态：0成功 1失败
```

### 查询系统状态 (0x0103)

**上位机发送：**
```
命令: 0x0103
参数: 无（0字节）
```

**下位机返回：**
```
命令: 0x8103
参数:
  系统状态(1) + 错误码(2) + 运行时间(4) + CPU使用率(1) + 温度(1)
  系统状态：bit0急停 bit1报警 bit2初始化完成
```

---

## 5. 电机命令 (0x02)

### 运动控制 (0x0200)

**上位机发送：**
```
命令: 0x0200
参数: 电机号(1) + 模式(1) + 位置(4) + 速度(4) + 加速度(4) + 参数(1)
      模式：0停止 1正转 2反转 3相对 4绝对
      参数：bit0等待完成标志
```

**下位机返回：**
```
命令: 0x8200
参数: 状态(1) + 电机号(1)
      
      状态：0成功 1编号无效 2电机忙 3参数错误 4未找零 5超限
```

### 找零 (0x0201)

**上位机发送：**
```
命令: 0x0201
参数: 电机号(1) + 方向(1) + 找零速度(4) + 找零模式(1)
      电机号：0xFF表示所有电机
      方向：0负方向 1正方向
      找零模式：0碰限位 1碰原点 2编码器Z相
```

**下位机返回：**
```
命令: 0x8201
参数: 状态(1) + 电机号(1) + 找零结果(1) + 找零后位置(4)
      
      状态：0成功 1电机号无效 2参数错误
      找零结果：0找零中 1成功 2失败 3超时
```

### 急停 (0x0202)

**上位机发送：**
```
命令: 0x0202
参数: 电机号(1) + 停止模式(1)
      电机号：0xFF表示所有电机
      停止模式：0减速停 1立即停
```

**下位机返回：**
```
命令: 0x8202
参数: 状态(1) + 电机号(1)
      
      状态：0成功 1电机号无效
```

### 查询状态 (0x0203)

**上位机发送：**
```
命令: 0x0203
参数: 电机号(1)
      0xFF查询所有电机
```

**下位机返回：**
```
命令: 0x8203
参数: 
  单个电机：电机号(1) + 状态(1) + 当前位置(4) + 当前速度(4) + 目标位置(4) + 错误码(2)
  所有电机：[电机号(1) + 状态(1) + 位置(4) + 速度(4) + 目标位置(4) + 错误码(2)] × N
      
      状态：bit0运行中 bit1方向 bit2已找零 bit3报警 bit4正限位 bit5负限位
```

### 设置参数 (0x0204)

**上位机发送：**
```
命令: 0x0204
参数: 电机号(1) + 参数类型(1) + 参数值(4)
      参数类型：0最大速度 1最大加速度 2回零速度 3脉冲当量 4软限位使能 5正向软限位 6负向软限位
```

**下位机返回：**
```
命令: 0x8204
参数: 状态(1) + 电机号(1)
      
      状态：0成功 1电机号无效 2参数类型无效 3参数值无效
```

---

## 6. 光栅尺命令 (0x03)

### 找零 (0x0300)

**上位机发送：**
```
命令: 0x0300
参数: 光栅尺号(1) + 模式(1)
      光栅尺号：0xFF表示所有
      模式：0清零当前位置 1查找参考点
```

**下位机返回：**
```
命令: 0x8300
参数: 状态(1) + 光栅尺号(1) + 找零结果(1) + 找零后位置(4)
      
      状态：0成功 1光栅尺号无效 2参数错误
      找零结果：1成功 2失败
```

### 查询状态 (0x0301)

**上位机发送：**
```
命令: 0x0301
参数: 光栅尺号(1)
      0xFF查询所有光栅尺
```

**下位机返回：**
```
命令: 0x8301
参数: 
  单个光栅尺：光栅尺号(1) + 状态(1) + 当前位置(4) + 速度(4) + 错误码(2)
  所有光栅尺：[光栅尺号(1) + 状态(1) + 位置(4) + 速度(4) + 错误码(2)] × N
      
      状态：bit0在线 bit1已找零 bit2数据有效 bit3报警
```

### 定位运动 (0x0302)

**上位机发送：**
```
命令: 0x0302
参数: 光栅尺号(1) + 模式(1) + 目标位置(4) + 速度(4) + 加速度(4)
      模式：3相对运动 4绝对运动
```

**下位机返回：**
```
命令: 0x8302
参数: 状态(1) + 光栅尺号(1)
      
      状态：0成功 1光栅尺号无效 2参数错误 3光栅尺离线
```

---

## 7. 压电转盘 (0x04)

### 控制 (0x0400)

**上位机发送：**
```
命令: 0x0400
参数: 转盘号(1) + 模式(1) + 目标角度(4) + 转速(4) + 加速度(4)
      模式：0停止 1正转 2反转 3角度定位
      角度：角度×10000（支持小数）
      转速：度/秒×100
      加速度：度/秒²×100
```

**下位机返回：**
```
命令: 0x8400
参数: 状态(1) + 转盘号(1)
      
      状态：0成功 1转盘号无效 2参数错误
```

### 查询状态 (0x0401)

**上位机发送：**
```
命令: 0x0401
参数: 转盘号(1)
```

**下位机返回：**
```
命令: 0x8401
参数: 转盘号(1) + 状态(1) + 当前角度(4) + 当前转速(4) + 错误码(2)
      
      状态：bit0运行中 bit1方向 bit2已找零 bit3报警
```

---

## 8. 压电螺钉 (0x05)

### 控制 (0x0500)

**上位机发送：**
```
命令: 0x0500
参数: 螺钉号(1) + 模式(1) + 目标位置(4) + 速度(4)
      螺钉号：0xFF表示所有螺钉
      模式：0停止 1伸长 2缩短 3相对运动 4绝对运动
```

**下位机返回：**
```
命令: 0x8500
参数: 状态(1) + 螺钉号(1)
      
      状态：0成功 1螺钉号无效 2参数错误
```

### 查询状态 (0x0501)

**上位机发送：**
```
命令: 0x0501
参数: 螺钉号(1)
      0xFF查询所有螺钉
```

**下位机返回：**
```
命令: 0x8501
参数: 
  单个螺钉：螺钉号(1) + 状态(1) + 当前位置(4) + 当前速度(4) + 错误码(2)
  所有螺钉：[螺钉号(1) + 状态(1) + 位置(4) + 速度(4) + 错误码(2)] × N
      
      状态：bit0运行中 bit1方向 bit2已找零 bit3报警
```

---

## 9. 批量控制 (0x06) 

### 批量电机 (0x0600)

**上位机发送：**
```
命令: 0x0600
参数: 电机数量(1) + [电机号(1) + 模式(1) + 位置(4) + 速度(4) + 加速度(4) + 参数(1)] × N
      每个电机16字节
```

**下位机返回：**
```
命令: 0x8600
参数: 整体状态(1) + 电机数(1) + [电机号(1) + 状态(1)] × N
      
      整体状态：0全部成功 1部分失败 2全部失败
```

### 批量光栅尺 (0x0601)

**上位机发送：**
```
命令: 0x0601
参数: 光栅尺数量(1) + [光栅尺号(1) + 模式(1) + 位置(4) + 速度(4) + 加速度(4) + 保留(1)] × N
      每个光栅尺16字节
```

**下位机返回：**
```
命令: 0x8601
参数: 整体状态(1) + 光栅尺数(1) + [光栅尺号(1) + 状态(1)] × N
      
      整体状态：0全部成功 1部分失败 2全部失败
```

### 组合控制 (0x0602)

**上位机发送：**
```
命令: 0x0602
参数: 设备数(1) + [设备类型(1) + 设备号(1) + 模式(1) + 位置(4) + 速度(4) + 加速度(4) + 参数(1)] × N
      设备类型：1电机 2光栅尺 3压电转盘 4压电螺钉
      每个设备17字节
```

**下位机返回：**
```
命令: 0x8602
参数: 整体状态(1) + 设备数(1) + [设备类型(1) + 设备号(1) + 状态(1)] × N
      
      整体状态：0全部成功 1部分失败 2全部失败
```

### 批量找零 (0x0603)

**上位机发送：**
```
命令: 0x0603
参数: 设备数(1) + [设备类型(1) + 设备号(1) + 方向(1) + 速度(4) + 找零模式(1) + 保留(2)] × N
      设备类型：1电机 2光栅尺
      每个设备11字节
```

**下位机返回：**
```
命令: 0x8603
参数: 整体状态(1) + 设备数(1) + [设备类型(1) + 设备号(1) + 状态(1)] × N
      
      整体状态：0全部成功 1部分失败 2全部失败
```

### 批量急停 (0x0604)

**上位机发送：**
```
命令: 0x0604
参数: 设备数(1) + 停止模式(1) + [设备类型(1) + 设备号(1)] × N
      
      设备数：0xFF=所有设备（后面不需要设备列表）
             其他=具体数量N（后面跟N个设备）
      停止模式：0减速停 1立即停
```

**下位机返回：**
```
命令: 0x8604
参数: 状态(1) + 实际停止设备数(1)
      
      状态：0成功 1部分失败 2全部失败
```

### 批量查询 (0x0605)

**上位机发送：**
```
命令: 0x0605
参数: 设备数(1) + [设备类型(1) + 设备号(1)] × N
```

**下位机返回：**
```
命令: 0x8605
参数: 状态(1) + 设备数(1) + [各设备状态数据]
      
      状态：0成功 1部分失败 2参数错误
      各设备状态数据按查询顺序返回：
        电机：16字节（同0x8203返回）
        光栅尺：12字节（同0x8301返回）
        压电转盘：12字节（同0x8401返回）
        压电螺钉：12字节（同0x8501返回）
```

---

## 10. 主动上报 (0xF1)

> **注意：** 光栅尺数据上报不属于本协议格式，使用独立格式，此处不描述。

### 运动完成上报 (0xF101)

**下位机主动发送：**
```
命令: 0xF101
参数: 设备类型(1) + 设备号(1) + 完成状态(1) + 最终位置(4) + 运动时间(4)
      
      设备类型：1电机 2光栅尺 3压电转盘 4压电螺钉
      完成状态：0正常完成 1异常停止 2超时 3限位停止
```

### 报警上报 (0xF102)

**下位机主动发送：**
```
命令: 0xF102
参数: 报警类型(1) + 设备类型(1) + 设备号(1) + 错误码(2) + 报警描述(32)
      报警类型：1急停 2电机报警 3传感器故障 4通信超时 5过温
      设备类型：1电机 2光栅尺 3压电转盘 4压电螺钉
```

---

## 11. 错误码

| 范围            | 类型               |
| ------------- | ---------------- |
| 0x0000-0x00FF | 通用（参数错误、超时、未找零等） |
| 0x0100-0x01FF | 电机（驱动故障、过流、限位等）  |
| 0x0200-0x02FF | 光栅尺（通信故障、离线等）    |
| 0x0300-0x03FF | 压电设备（电压异常、超限等）   |

---

## 12. CRC校验

**C代码：**
```c
uint16_t CRC16_MODBUS(uint8_t *data, uint16_t length) {
    uint16_t crc = 0xFFFF;
    for (uint16_t i = 0; i < length; i++) {
        crc ^= data[i];
        for (uint8_t j = 0; j < 8; j++) {
            if (crc & 0x0001) crc = (crc >> 1) ^ 0xA001;
            else crc = crc >> 1;
        }
    }
    return crc;
}
```

**Python代码：**
```python
def crc16_modbus(data: bytes) -> int:
    crc = 0xFFFF
    for byte in data:
        crc ^= byte
        for _ in range(8):
            crc = (crc >> 1) ^ 0xA001 if crc & 0x0001 else crc >> 1
    return crc
```

---

## 13. 使用示例

### 示例1：握手命令

**上位机发送：**
```
$0500 0100 01;A3B2

解析：
$ - 帧头
0500 - 长度=5字节（2+2+1）
0100 - 命令=0x0100（握手）
01 - 协议版本=1
; - 帧尾
A3B2 - CRC校验（示例值）
```

**下位机返回：**
```
$3200 8100 00 01 12345678 4D6F746F72436F6E74726F6C6C657200... 0B 06 01 03 01000000;XXXX

解析：
3200 - 长度=50字节（2+2+1+1+4+32+1+1+1+1+4）
8100 - 应答命令（0x0100+0x8000）
00 - 成功
01 - 协议版本
12345678 - 设备ID
4D6F... - 设备名称"MotorController"（32字节）
0B - 电机总数11
06 - 光栅尺6个
01 - 压电转盘1个
03 - 压电螺钉3个
01000000 - 固件版本1.0.0.0
```

### 示例2：控制单个电机

**上位机发送：**
```
$1300 0200 01 03 A0860100 10270000 88130000 00;XXXX

解析：
$
1300 - 长度=19字节（2+2+1+1+4+4+4+1）
0200 - 命令=0x0200（电机运动）
01 - 电机1
03 - 相对运动
A0860100 - 位置=100000脉冲（小端）
10270000 - 速度=10000
88130000 - 加速度=5000
00 - 参数（立即返回）
;XXXX
```

**下位机返回：**
```
$0600 8200 00 01;XXXX

解析：
0600 - 长度=6字节（2+2+1+1）
8200 - 应答命令（0x0200+0x8000）
00 - 成功
01 - 电机1
```

**下位机运动完成主动上报：**
```
$0F00 F101 01 01 00 A0860100 E8030000;XXXX

解析：
0F00 - 长度=15字节（2+2+1+1+1+4+4）
F101 - 运动完成上报
01 - 设备类型（电机）
01 - 电机1
00 - 正常完成
A0860100 - 最终位置100000
E8030000 - 耗时1000ms
```

### 示例3：查询系统状态

**上位机发送：**
```
$0400 0103;XXXX

解析：
0400 - 长度=4字节（2+2+0）
0103 - 查询系统状态
（无参数）
```

**下位机返回：**
```
$0D00 8103 00 0000 10270000 32 1A;XXXX

解析：
0D00 - 长度=13字节（2+2+1+2+4+1+1）
8103 - 应答命令
00 - 系统状态：00000000（正常）
0000 - 无错误
10270000 - 运行时间10000秒
32 - CPU使用率50%
1A - 温度26℃
```

### 示例4：批量控制3个电机

**上位机发送：**
```
$3500 0600 03 [电机0数据] [电机2数据] [电机5数据];XXXX

详细数据：
$
3500 - 长度=53字节（2+2+1+16×3）
0600 - 批量电机命令
03 - 3个电机

电机0数据（16字节）：
00 - 电机0
03 - 相对运动
A0860100 - 100000脉冲
A0860100 - 速度100000
88130000 - 加速度5000
00 - 参数

电机2数据（16字节）：
02 - 电机2
04 - 绝对运动
00204E00 - 到5000000位置
404B4C00 - 速度5000000
88130000 - 加速度5000
00 - 参数

电机5数据（16字节）：
05 - 电机5
01 - 正转
00000000 - 位置（正转不需要）
10270000 - 速度10000
00000000 - 加速度
00 - 参数
;XXXX
```

**下位机返回：**
```
$0C00 8600 00 03 00 00 02 00 05 00;XXXX

解析：
0C00 - 长度=12字节（2+2+1+1+2×3）
8600 - 应答命令（0x0600+0x8000）
00 - 全部成功
03 - 3个电机
00 00 - 电机0成功
02 00 - 电机2成功
05 00 - 电机5成功
```

### 示例5：查询电机状态

**上位机发送：**
```
$0500 0203 01;XXXX

解析：
0500 - 长度=5字节（2+2+1）
0203 - 查询电机状态
01 - 电机1
```

**下位机返回：**
```
$1400 8203 01 05 A0860100 10270000 A0860100 0000;XXXX

解析：
1400 - 长度=20字节（2+2+1+1+4+4+4+2）
8203 - 应答命令（0x0203+0x8000）
01 - 电机1
05 - 状态：00000101（运行中+已找零）
A0860100 - 当前位置100000
10270000 - 当前速度10000
A0860100 - 目标位置100000
0000 - 无错误
```

### 示例6：急停所有电机

**上位机发送：**
```
$0600 0202 FF 01;XXXX

解析：
0600 - 长度=6字节（2+2+1+1）
0202 - 电机急停
FF - 所有电机
01 - 立即停止
```

**下位机返回：**
```
$0600 8202 00 FF;XXXX

解析：
0600 - 长度=6字节（2+2+1+1）
8202 - 应答命令（0x0202+0x8000）
00 - 成功
FF - 所有电机
```

### 示例7：报警上报

**下位机主动发送：**
```
$2B00 F102 02 01 03 0102 4D6F746F72204F7665726375727265726E74...;XXXX

解析：
2B00 - 长度=43字节（2+2+1+1+1+2+32）
F102 - 报警上报
02 - 报警类型（电机报警）
01 - 设备类型（电机）
03 - 设备号（电机3）
0102 - 错误码0x0102（电机过流）
4D6F... - 报警描述"Motor Overcurrent"（32字节）
```

---

## 14. 扩展

- 命令码0x07-0x7F预留（未来新功能）
- 应答码0x87-0xFF预留（对应未来命令）
- 每个命令下的子命令0x00-0xFF共256个
- 数据域可使用TLV结构扩展可选参数
- 握手时交换版本号，保证兼容性

---

## 版本

| 版本   | 日期         | 改动                        |
| ---- | ---------- | ------------------------- |
| v1.0 | 2025-10-23 | 初版                        |
| v1.1 | 2025-10-23 | 去掉序号，应答用+0x8000规则，完善所有状态 |

---

**重要说明：**

1. **帧格式：** `$[数据];[校验]`，数据是二进制
2. **数据结构：** 长度(2) + 命令(2) + 参数(N)
3. **字节序：** 小端序（低字节在前）
4. **长度计算：** 长度 = 2 + 2 + 参数字节数
5. **应答规则：** 应答命令 = 发送命令 + 0x8000
6. **校验范围：** 从`$`后到`;`前的所有字节
7. **优先级：** 急停命令(0x0202、0x0604)最高，必须立即响应
8. **主动上报：** 运动完成0xF101，报警0xF102
9. **光栅尺上报：** 独立格式，不属于本协议

**小端序示例：**
```
  10000 → 发送：10 27 00 00
  100000 → 发送：A0 86 01 00
```

---

## FAQ

**Q: 帧格式到底是咋样的？**
A: `$数据;校验`，数据部分包含：长度(2)+命令(2)+参数(N)，校验是CRC16。看示例最清楚。

**Q: 长度字段怎么算？**
A: 长度 = 2(长度字段本身) + 2(命令) + N(参数)。比如无参数命令长度=4，有1字节参数长度=5。用小端序发送。

**Q: 应答命令字怎么算？**
A: 应答命令=发送命令+0x8000。比如发送0x0100，应答就是0x8100。这样一眼就能看出是应答。

**Q: 上位机和下位机格式一样吗？**
A: 一样，都是`$数据;校验`。下位机应答命令=上位机发送命令+0x8000（0x8xxx），主动上报用0xF1xx。

**Q: 参数可以是0字节吗？**
A: 可以，比如查询系统状态(0x0103)就不需要参数。

**Q: 一次最多控制几个设备？**
A: 电机11个、光栅尺6个、混合控制建议不超过16个。

**Q: 批量命令某个设备失败咋办？**
A: 返回时会告诉你每个设备的状态，失败的重发就行。

**Q: CRC校验范围是啥？**
A: 从`$`到`;`之间的所有数据（包括长度、命令、参数），不包括`$`、`;`和校验值本身。

